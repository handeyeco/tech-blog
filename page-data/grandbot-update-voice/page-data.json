{"componentChunkName":"component---src-templates-blog-post-js","path":"/grandbot-update-voice/","result":{"data":{"site":{"siteMetadata":{"title":"Tech Blog"}},"markdownRemark":{"id":"05124c66-e79e-59dc-b9f4-5095962bbdff","excerpt":"Disclaimer: I don’t know what I’m talking about. I’m a JavaScript dev who’s just learning this stuff too. I’m sharing what I think I learned, but that doesn’t…","html":"<p><em><strong>Disclaimer:</strong> I don’t know what I’m talking about. I’m a JavaScript dev who’s just learning this stuff too. I’m sharing what I <strong>think</strong> I learned, but that doesn’t make it the truth.</em></p>\n<p><em>Project originally inspired by the work of <a href=\"https://twitter.com/MohitBhoite\">Mohit Bhoite</a>.</em></p>\n<p><em>Code references the state as of <a href=\"https://github.com/handeyeco/Grandbot/tree/2020-05-15\">this tag</a>.</em></p>\n<hr>\n<p>The past week has been a big one for the newly named Grandbot project. I finally got to a place where I felt it was time to take a deep dive into C++ and implemented a bunch of new features while learning more about electronics and Arduino programming. Even though the hardware side of things is fairly straightforward, I’m breaking this post into several parts since the code is exponentially more complex now.</p>\n<p>This post is about using a passive buzzer to let Grandbot sing randomly generated melodies.</p>\n<h2>Adding a buzzer</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/ed9ed32c3a0583776b3f7c48032eae34/c8451/schematic.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwX/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAdSDM1lQf//EABgQAQADAQAAAAAAAAAAAAAAAAEAEBEh/9oACAEBAAEFAuzVdtn/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAXEAADAQAAAAAAAAAAAAAAAAAAIDFR/9oACAEBAAY/AqYv/8QAGxAAAgIDAQAAAAAAAAAAAAAAABEBMUFRYZH/2gAIAQEAAT8hejwStpw6lk4Jssf/2gAMAwEAAgADAAAAEOsv/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBABAAICAwEAAAAAAAAAAAAAAQARITFRYXHh/9oACAEBAAE/EGwShdP1BTkHo+5ljALkKmkaZvn/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Schematic of the build\"\n        title=\"Schematic of the build\"\n        src=\"/tech-blog/static/ed9ed32c3a0583776b3f7c48032eae34/1c72d/schematic.jpg\"\n        srcset=\"/tech-blog/static/ed9ed32c3a0583776b3f7c48032eae34/a80bd/schematic.jpg 148w,\n/tech-blog/static/ed9ed32c3a0583776b3f7c48032eae34/1c91a/schematic.jpg 295w,\n/tech-blog/static/ed9ed32c3a0583776b3f7c48032eae34/1c72d/schematic.jpg 590w,\n/tech-blog/static/ed9ed32c3a0583776b3f7c48032eae34/a8a14/schematic.jpg 885w,\n/tech-blog/static/ed9ed32c3a0583776b3f7c48032eae34/fbd2c/schematic.jpg 1180w,\n/tech-blog/static/ed9ed32c3a0583776b3f7c48032eae34/c8451/schematic.jpg 1974w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<figcaption>Schematic of the build</figcaption>\n<h3>Components</h3>\n<ul>\n<li>Passive buzzer</li>\n<li>220 Ohm resistor</li>\n<li>Arduino Uno</li>\n</ul>\n<h4>Component notes</h4>\n<p>I’m using a passive buzzer that came with a kit, but I can’t find any part number for it. The datasheet says it’s capable of handling 3-12V and its resistance is “16R” (16 Ohms?)</p>\n<p>From this thread <a href=\"https://forum.arduino.cc/index.php?topic=16262.0\">this thread</a>:</p>\n<blockquote>\n<p>According to the buzzer documentation, the ‘coil resistance’ is 42R +- (plus or minus) 6.3</p>\n<p>ohms law: voltage = current * resistance</p>\n<p>Other turn-arounds of this formula:</p>\n<p>resistance = voltage / current</p>\n<p>current = voltage / resistance (we’re using this one)</p>\n<p>Arduino voltage is 5 volts from USB (correct? does this change with plug up to 12v?)</p>\n<p>5 volts / 42R = .119A, or 119mA: That’s 79mA too much current.</p>\n<p>To fix:</p>\n<p>100R resistor + 42R buzzer = 142R</p>\n<p>5v / 142R = .0352Am, or 35.2mA: That’s less than the 40mA of the Arduino AVR: Success!</p>\n</blockquote>\n<p>So for me <code class=\"language-text\">5V / 16R = .312A</code>. 312mA > 40mA, so I need to limit the current. I added 220 Ohms: <code class=\"language-text\">5V / (16R + 220) = .021A</code>. 21mA &#x3C; 40mA, so we’re good to go! I could have used less resistance, but I’m fine with the buzzer being a little quieter.</p>\n<h3>Code</h3>\n<p>This is just the general idea, not the complete code. There’s a link above to the full codebase.</p>\n<p>The code uses an array of pitches and the Tone library to create little melodies based on Grandbot’s mood. I want to improve the different mood sounds, but right now he plays the same two low frequencies when unhappy, a random note when in a neutral mood, a series of random notes when happy, and a random Major 7th chord when going to sleep.</p>\n<p>It’s all pretty straightforward, the only tricky part was getting true randomness. Arduino’s <code class=\"language-text\">random</code> function is a pseudorandom number generator, so Grandbot kept playing the same tunes. The solution was to use a floating analog pin as a seed.</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// main.cpp</span>\n\n<span class=\"token comment\">// Pin connected to buzzer</span>\n<span class=\"token comment\">// (needs to be a PWM pin)</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">voicePin</span> <span class=\"token expression\"><span class=\"token number\">3</span></span></span>\n\n<span class=\"token comment\">// Leave unconnected</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">randomPin</span> <span class=\"token expression\">A5</span></span>\n\n<span class=\"token comment\">// ...set other pins...</span>\n\nGrandbot gb <span class=\"token operator\">=</span> <span class=\"token function\">Grandbot</span><span class=\"token punctuation\">(</span>dataPin<span class=\"token punctuation\">,</span> clockPin<span class=\"token punctuation\">,</span> loadPin<span class=\"token punctuation\">,</span> voicePin<span class=\"token punctuation\">,</span> redPin<span class=\"token punctuation\">,</span> greenPin<span class=\"token punctuation\">,</span> bluePin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token keyword\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">randomSeed</span><span class=\"token punctuation\">(</span><span class=\"token function\">analogRead</span><span class=\"token punctuation\">(</span>randomPin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then we have a <code class=\"language-text\">Voice</code> class:</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// Voice.h</span>\n\nclass <span class=\"token class-name\">Voice</span> <span class=\"token punctuation\">{</span>\n  private<span class=\"token operator\">:</span>\n    <span class=\"token keyword\">int</span> m_voicePin<span class=\"token punctuation\">;</span>\n    static const <span class=\"token keyword\">int</span> pitches<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">playMajor7th</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">playRandomSequence</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">playRandomNote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> note<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> duration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  public<span class=\"token operator\">:</span>\n    <span class=\"token function\">Voice</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> voicePin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">feedback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">emote</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> mood<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This has some helper functions for using Tone:</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// Voice.cpp</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Voice</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> note<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">play</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">,</span> <span class=\"token number\">75</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Voice</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> note<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> duration<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">tone</span><span class=\"token punctuation\">(</span>m_voicePin<span class=\"token punctuation\">,</span> note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span>duration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">noTone</span><span class=\"token punctuation\">(</span>m_voicePin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>An array of pitches:</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// Voice.cpp</span>\n\nconst <span class=\"token keyword\">int</span> Voice<span class=\"token double-colon punctuation\">::</span>pitches<span class=\"token punctuation\">[</span><span class=\"token number\">28</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> \n  <span class=\"token number\">1047</span><span class=\"token punctuation\">,</span> \n  <span class=\"token number\">1109</span><span class=\"token punctuation\">,</span> \n  <span class=\"token number\">1175</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// ...etc...</span>\n  <span class=\"token number\">4435</span><span class=\"token punctuation\">,</span> \n  <span class=\"token number\">4699</span><span class=\"token punctuation\">,</span> \n  <span class=\"token number\">4978</span> \n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Some internal sound making fun:</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// Voice.cpp</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Voice</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">playMajor7th</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> duration <span class=\"token operator\">=</span> <span class=\"token number\">250</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Pick the chord's starting note</span>\n  <span class=\"token keyword\">int</span> start <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Step through the Major 7th intervals</span>\n  <span class=\"token function\">play</span><span class=\"token punctuation\">(</span>pitches<span class=\"token punctuation\">[</span>start<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> duration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">play</span><span class=\"token punctuation\">(</span>pitches<span class=\"token punctuation\">[</span>start<span class=\"token operator\">+</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> duration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">play</span><span class=\"token punctuation\">(</span>pitches<span class=\"token punctuation\">[</span>start<span class=\"token operator\">+</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> duration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">play</span><span class=\"token punctuation\">(</span>pitches<span class=\"token punctuation\">[</span>start<span class=\"token operator\">+</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> duration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Voice</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">playRandomSequence</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> len <span class=\"token operator\">=</span> <span class=\"token function\">random</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> len<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">playRandomNote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Voice</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">playRandomNote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> rand <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">28</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> note <span class=\"token operator\">=</span> Voice<span class=\"token double-colon punctuation\">::</span>pitches<span class=\"token punctuation\">[</span>rand<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">play</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I’ve since found a better way to get a random entry from an array in C++ (by first determining array length), but this has been working for now.</p>\n<p>Last in this file are two public methods:</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// Voice.cpp</span>\n\n<span class=\"token comment\">// Chirp when we want feedback</span>\n<span class=\"token comment\">// (not currently in use)</span>\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Voice</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">feedback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">playRandomNote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Play a melody based on mood (stored as an int)</span>\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Voice</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">emote</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> mood<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>mood<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Sleeping</span>\n    <span class=\"token keyword\">case</span> <span class=\"token number\">0</span><span class=\"token operator\">:</span>\n      <span class=\"token function\">playMajor7th</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Happy</span>\n    <span class=\"token keyword\">case</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span>\n      <span class=\"token function\">playRandomSequence</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Neutral</span>\n    <span class=\"token keyword\">case</span> <span class=\"token number\">2</span><span class=\"token operator\">:</span>\n      <span class=\"token function\">playRandomNote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Unhappy</span>\n    <span class=\"token keyword\">case</span> <span class=\"token number\">3</span><span class=\"token operator\">:</span>\n      <span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Grandbot stores an instance of Voice and calls it from time-to-time.</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token class-name\">Grandbot</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Grandbot</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> dataPin<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> clockPin<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> loadPin<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> voicePin<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> redPin<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> greenPin<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> bluePin<span class=\"token punctuation\">)</span>\n  <span class=\"token operator\">:</span> <span class=\"token function\">lc</span><span class=\"token punctuation\">(</span><span class=\"token function\">LedControl</span><span class=\"token punctuation\">(</span>dataPin<span class=\"token punctuation\">,</span> clockPin<span class=\"token punctuation\">,</span> loadPin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">voice</span><span class=\"token punctuation\">(</span><span class=\"token function\">Voice</span><span class=\"token punctuation\">(</span>voicePin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">light</span><span class=\"token punctuation\">(</span><span class=\"token function\">Light</span><span class=\"token punctuation\">(</span>redPin<span class=\"token punctuation\">,</span> greenPin<span class=\"token punctuation\">,</span> bluePin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Initializing stuff</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Grandbot</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">updateMood</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> last <span class=\"token operator\">=</span> mood<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> next<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// ...determine next mood...</span>\n\n  mood <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>last <span class=\"token operator\">!=</span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    voice<span class=\"token punctuation\">.</span><span class=\"token function\">emote</span><span class=\"token punctuation\">(</span>mood<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Grandbot</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...sleep stuff...</span>\n\n  <span class=\"token comment\">// So we don't play a sound</span>\n  <span class=\"token comment\">// if we reset at night</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastMood <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    voice<span class=\"token punctuation\">.</span><span class=\"token function\">emote</span><span class=\"token punctuation\">(</span>mood<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Grandbot</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...playful stuff...</span>\n\n  <span class=\"token function\">updateMood</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  voice<span class=\"token punctuation\">.</span><span class=\"token function\">emote</span><span class=\"token punctuation\">(</span>mood<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Code notes</h4>\n<ul>\n<li>I should probably have a separate Pitch file.</li>\n<li>Randomly selecting things should be done by determining the array length, rather than using a hard-coded value.</li>\n<li>I’d like to add more functions for specific chords and then auto-generate small chord progressions. I also think this is a good foundation for a game to play with Grandbot (like Simon).</li>\n<li>The instance of Voice created in the Grandbot constructor is made with an initializer list. The compiler threw an error because I didn’t have a default constructor for Voice, so I just initialized it in the initializer list. I’m not sure if there was something else I should have done.</li>\n<li>I’m considering creating the class instances outside of Grandbot and handing them to Grandbot’s constructor rather than creating them in the constructor. The downside is I wouldn’t be able to run to Grandbots on one Arduino that way. 🤷‍♀️</li>\n</ul>\n<h2>Conclusion</h2>\n<p>Really love his random sequences. The Major 7th chord is pretty, but the random sequence makes it seem like he’s trying to communicate. I do want to make the neutral response better though, it’s a little boring right now.</p>\n<p>Another problem is that using <code class=\"language-text\">delay</code> for note length blocks the thread. For instance the sleep melody is 4 notes at 250ms; that means nothing else can happen for the 1 second it’s playing that tune. Not sure if there’s a pay to pass this functionality to an external IC like I did with multiplexing the 4D7S display.</p>","frontmatter":{"title":"Grandbot: Voice","date":"May 15, 2020","description":"Letting Grandbot sing randomly generated tunes."}}},"pageContext":{"slug":"/grandbot-update-voice/","previous":{"fields":{"slug":"/grandbot-update-sleep/"},"frontmatter":{"title":"Grandbot: Sleep"}},"next":{"fields":{"slug":"/grandbot-update-play/"},"frontmatter":{"title":"Grandbot: Play"}}}},"staticQueryHashes":["63159454"]}