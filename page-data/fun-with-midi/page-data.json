{"componentChunkName":"component---src-templates-blog-post-js","path":"/fun-with-midi/","result":{"data":{"site":{"siteMetadata":{"title":"Tech Blog"}},"markdownRemark":{"id":"b4415f31-115b-5ba1-a97e-c2f667fb949b","excerpt":"This was originally written for a zine. Code, schematics, etc can be found on Github. Hey üëã My name is Matthew and I don‚Äôt understand analog circuits. Boy have‚Ä¶","html":"<p>This was originally written for a zine. Code, schematics, etc can be <a href=\"https://github.com/handeyeco/fun-with-midi\">found on Github</a>.</p>\n<hr>\n<p>Hey üëã My name is Matthew and I don‚Äôt understand analog circuits.</p>\n<p>Boy have I tried though. Just looking around my desk I can see my copy of There Are No Electrons by Amdahl, Practical Electronics For Inventors by Scherz, and Electronic Projects For Musicians by Anderton. My degree is in Music Business, Performance, and Technology and I‚Äôve worked TWO jobs assembling modular synthesizers - one before and one after my career as an audio engineer, before I made the switch to software development.</p>\n<p>Circuits are hard. I discovered something though - on my 100th attempt at learning electrical engineering - that there‚Äôs buckets of fun to be had with a relatively simple circuit and some basic programming skills.</p>\n<p>In this article I‚Äôm going to talk a little about MIDI.</p>\n<h2>WARNING</h2>\n<p>Your hearing is fragile, be sure to protect it when programmatically adjusting audio. I recommend getting some cheap, small speakers from a thrift store to use while debugging. Always start each iteration with your volume turned down and carefully turn the volume up when you‚Äôre confident your project is working.</p>\n<p>You can always fix bugs, but you can‚Äôt fix tinnitus!</p>\n<h2>What we‚Äôre doing</h2>\n<p>We‚Äôre going to use an Arduino and a simple MIDI out circuit for three sketches:</p>\n<ol>\n<li>To get things started, we‚Äôll run a sketch that makes sure all the buttons, potentiometers, and LEDs are working.</li>\n<li>Then we‚Äôll test our MIDI out circuit by making a vanilla MIDI CC controller that lets us pick a MIDI CC and a value for that CC.</li>\n<li>Finally we‚Äôll look at a more creative application of MIDI by making a random MIDI CC generator that can be used to turn boring synth patches into modular-like bleeps and bloops.</li>\n</ol>\n<p>Each sketch will build on the previous sketch so hopefully by the end you can take these ideas and build your own weird MIDI tool!</p>\n<h2>What I‚Äôm using</h2>\n<p>For these examples I‚Äôm using an Arduino Mega ($50; an Uno should work fine though) and the Sparkfun MIDI Shield ($24). Arduino is designed to be a beginner-friendly platform for people who are learning about microcontrollers. Shields are just circuits that are meant to extend the functionality of another circuit.</p>\n<p>If you want to follow along and have the cash, I highly recommend throwing some dough at both Arduino and Sparkfun - they contribute a lot to the DIY scene. However you can get equally far with a $10 Arduino knock-off and some common components.</p>\n<h2>The circuit</h2>\n<p>Even though MIDI in makes everything more fun, for the sake of simplicity I‚Äôm just using MIDI out, two potentiometers, three buttons, and two LEDs. You can see the Sparkfun MIDI Shield schematic on their site, but the parts I‚Äôm using for these examples are:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/7e995fa6d909c88a421c98c0552175cf/b85c3/simplified-schematic.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.1891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACT0lEQVQ4y31T227TQBTM//8OpaKolQgIVeKtSA1KaRLXsddee2/ei21oyzB2mpK+8HC0sXM8Zy5nFyk5/K/63sF5DR8Mhr5DZIXp/WuPnU/b6flc9Gw4rTeAfcAwJoLZuSLfaV2hFg8YBj/3t10FaySca+bnxTQhntSRVeIH0eaw4hZNfoOuvUeIFo6AqtjC9waJrFvJnk5BZnfQPBdaCdRNBqn2rByGz4Fs+uDhqiWHXMCGj/zwCkFLDL8i4uigjECzXkHdrdBm99BNQWsMFpb+2FbAqppg1TyxdgJSZNiszhCfPuEJXyCqS9iqRD/6g4rUoZMEofzoFK2JB8mT0TbIuVpf0hNWJKDMkK/f4xmf8chq6ksyFhjJcCDY5KdyLfK6gCapY0iLaVKgd3727+BhGtjMxmJ9TsAl/pChbS6hxA62VxzewIUWykt00czezr4fU/aM3JH2NN1HJknDRblFRslPBAS+otidQdyv4UaNhio8QbrYEljN8lM6BYwKjc7RFhml5XjY3KLcb3F3845yl0jPS2y3Z1C7DOPvBEOGHRONHKydRD8z7E4Ak4HpJJQsYW3Dmn4LhnLwMBJwv/8As8/RPyZo+ltv1/S8RbNZoWao6RXwxUNtGUT5wJQLlJsfMJ5S9DXX4xzCXEDXV3A1QyGgJ4DcUT6ZaQI33I5XhodFJiiTkiJHpJSg63lidBXKn99QZN+hpx3lf47LPH1jqGLk8hsmHRnMG8Aj6DCGwxUcXnZtCJDTtWJQxtv5JnQEnFZmAp56pzPGf3f7L26X1Abi2SjOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Schematic of MIDI out circuit with simple controls\"\n        title=\"Schematic of MIDI out circuit with simple controls\"\n        src=\"/tech-blog/static/7e995fa6d909c88a421c98c0552175cf/fcda8/simplified-schematic.png\"\n        srcset=\"/tech-blog/static/7e995fa6d909c88a421c98c0552175cf/12f09/simplified-schematic.png 148w,\n/tech-blog/static/7e995fa6d909c88a421c98c0552175cf/e4a3f/simplified-schematic.png 295w,\n/tech-blog/static/7e995fa6d909c88a421c98c0552175cf/fcda8/simplified-schematic.png 590w,\n/tech-blog/static/7e995fa6d909c88a421c98c0552175cf/efc66/simplified-schematic.png 885w,\n/tech-blog/static/7e995fa6d909c88a421c98c0552175cf/c83ae/simplified-schematic.png 1180w,\n/tech-blog/static/7e995fa6d909c88a421c98c0552175cf/b85c3/simplified-schematic.png 2580w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>MIDI out, which is just a 5 pin DIN socket with two resistors</li>\n<li>Two potentiometers acting as voltage dividers going into analog pins on the Arduino</li>\n<li>Three switches going into digital pins on the Arduino (we‚Äôll be using the internal pull-up resistors)</li>\n<li>Two LEDs with current limiting resistors</li>\n</ul>\n<p>If you‚Äôve been playing with electronics already, there‚Äôs a good chance you have most of this stuff lying around except maybe the Arduino and the DIN socket (using a 3.5mm jack for TRS MIDI is also an option).</p>\n<h2>Sketch #1: Board Test</h2>\n<p><a href=\"https://github.com/handeyeco/fun-with-midi/blob/main/board-test/board-test.ino\">Source code</a></p>\n<p>This first sketch is just testing the pots, buttons, and LEDs. First we let the program know which pins we‚Äôre using for everything:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// button pins (digital)</span>\nbyte S3_PIN <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\nbyte S4_PIN <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\nbyte S5_PIN <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// pot pins (analog)</span>\nbyte RV1_PIN <span class=\"token operator\">=</span> A1<span class=\"token punctuation\">;</span>\nbyte RV2_PIN <span class=\"token operator\">=</span> A0<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// LED pins (digital)</span>\nbyte GRN_LED_PIN <span class=\"token operator\">=</span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>\nbyte RED_LED_PIN <span class=\"token operator\">=</span> <span class=\"token number\">7</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Then we declare some variables so we can keep track of what everything is doing as the sketch runs:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// declare read state</span>\n<span class=\"token keyword\">bool</span> S3_STATE <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">bool</span> S4_STATE <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">bool</span> S5_STATE <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> RV1_STATE <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> RV2_STATE <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">setup</code> is the code that runs at the beginning of the sketch:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">void</span> <span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// setup for printing to our monitor</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token number\">9600</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// the switches use the built-in pull-up resistors</span>\n  <span class=\"token function\">pinMode</span><span class=\"token punctuation\">(</span>S3_PIN<span class=\"token punctuation\">,</span> INPUT_PULLUP<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pinMode</span><span class=\"token punctuation\">(</span>S4_PIN<span class=\"token punctuation\">,</span> INPUT_PULLUP<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pinMode</span><span class=\"token punctuation\">(</span>S5_PIN<span class=\"token punctuation\">,</span> INPUT_PULLUP<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// the pots don't use the pull-up resistors</span>\n  <span class=\"token function\">pinMode</span><span class=\"token punctuation\">(</span>RV1_PIN<span class=\"token punctuation\">,</span> INPUT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pinMode</span><span class=\"token punctuation\">(</span>RV2_PIN<span class=\"token punctuation\">,</span> INPUT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// then set up the LEDs as outputs</span>\n  <span class=\"token function\">pinMode</span><span class=\"token punctuation\">(</span>GRN_LED_PIN<span class=\"token punctuation\">,</span> OUTPUT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pinMode</span><span class=\"token punctuation\">(</span>RED_LED_PIN<span class=\"token punctuation\">,</span> OUTPUT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// do an initial read of everything</span>\n  <span class=\"token comment\">// so we can start looking for changes</span>\n  S3_STATE <span class=\"token operator\">=</span> <span class=\"token function\">digitalRead</span><span class=\"token punctuation\">(</span>S3_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  S4_STATE <span class=\"token operator\">=</span> <span class=\"token function\">digitalRead</span><span class=\"token punctuation\">(</span>S4_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  S5_STATE <span class=\"token operator\">=</span> <span class=\"token function\">digitalRead</span><span class=\"token punctuation\">(</span>S5_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  RV1_STATE <span class=\"token operator\">=</span> <span class=\"token function\">analogRead</span><span class=\"token punctuation\">(</span>RV1_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  RV2_STATE <span class=\"token operator\">=</span> <span class=\"token function\">analogRead</span><span class=\"token punctuation\">(</span>RV2_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">loop</code> runs over and over again so we can watch for changes:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// pot change threshold,</span>\n<span class=\"token comment\">// for what we consider a change</span>\n<span class=\"token keyword\">int</span> RV_THRESH <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// read pins</span>\n  <span class=\"token keyword\">bool</span> S3_READ <span class=\"token operator\">=</span> <span class=\"token function\">digitalRead</span><span class=\"token punctuation\">(</span>S3_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">bool</span> S4_READ <span class=\"token operator\">=</span> <span class=\"token function\">digitalRead</span><span class=\"token punctuation\">(</span>S4_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">bool</span> S5_READ <span class=\"token operator\">=</span> <span class=\"token function\">digitalRead</span><span class=\"token punctuation\">(</span>S5_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> RV1_READ <span class=\"token operator\">=</span> <span class=\"token function\">analogRead</span><span class=\"token punctuation\">(</span>RV1_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> RV2_READ <span class=\"token operator\">=</span> <span class=\"token function\">analogRead</span><span class=\"token punctuation\">(</span>RV2_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// if any button is pressed, light LED</span>\n  <span class=\"token keyword\">bool</span> pressed <span class=\"token operator\">=</span> S3_READ <span class=\"token operator\">&amp;&amp;</span> S4_READ <span class=\"token operator\">&amp;&amp;</span> S5_READ<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">digitalWrite</span><span class=\"token punctuation\">(</span>GRN_LED_PIN<span class=\"token punctuation\">,</span> pressed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">digitalWrite</span><span class=\"token punctuation\">(</span>RED_LED_PIN<span class=\"token punctuation\">,</span> pressed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// print and update state</span>\n  <span class=\"token comment\">// if a change is detected</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>S3_READ <span class=\"token operator\">!=</span> S3_STATE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"S3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    S3_STATE <span class=\"token operator\">=</span> S3_READ<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>S4_READ <span class=\"token operator\">!=</span> S4_STATE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"S4\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    S4_STATE <span class=\"token operator\">=</span> S4_READ<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>S5_READ <span class=\"token operator\">!=</span> S5_STATE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"S5\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    S5_STATE <span class=\"token operator\">=</span> S5_READ<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">abs</span><span class=\"token punctuation\">(</span>RV1_READ <span class=\"token operator\">-</span> RV1_STATE<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> RV_THRESH<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"RV1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    RV1_STATE <span class=\"token operator\">=</span> RV1_READ<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">abs</span><span class=\"token punctuation\">(</span>RV2_READ <span class=\"token operator\">-</span> RV2_STATE<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> RV_THRESH<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"RV2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    RV2_STATE <span class=\"token operator\">=</span> RV2_READ<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>What it‚Äôs doing:</p>\n<ol>\n<li>If any buttons are pressed, light up the LEDs</li>\n<li>If any button is pressed, print in the serial monitor which button was pressed</li>\n<li>If any pot is turned, print in the serial monitor which pot was turned</li>\n</ol>\n<p>Okay, not super fun so far, but hopefully we have a working Arduino connected to a working MIDI shield. Now let‚Äôs actually <em>do</em> something with the MIDI output.</p>\n<h2>Serial, USB, and MIDI</h2>\n<p>Okay, here‚Äôs some bummer news: the <code class=\"language-text\">Serial</code> protocol we used to print messages in the previous example doesn‚Äôt play well with hardware MIDI. The problem is that both USB communication and hardware MIDI rely on UART (connected to the TX/RX pins). This is why the MIDI shield has a prog/run switch: when we‚Äôre sending our sketch to the Arduino, we can‚Äôt also be receiving MIDI or our bits will get all mixed up. The switch turns off MIDI in while we program the microcontroller.</p>\n<p>This isn‚Äôt a huge issue for now since we‚Äôre only using MIDI out, but it‚Äôs something to keep in mind. It does however limit our ability to use <code class=\"language-text\">Serial.print</code> while also using MIDI.</p>\n<p>The good news is that some Arduinos have multiple UARTs; for example the Mega has 4 sets of UART pins. This means you can use one set for programming/debugging and one set for MIDI. Unfortunately the MIDI shield is designed to work with the Uno too, which only has one set, so the issues exists with the shield on the Mega.</p>\n<p>So:</p>\n<ol>\n<li>We won‚Äôt use <code class=\"language-text\">Serial.print</code> while also using MIDI</li>\n<li>If we have something plugged into MIDI in, we‚Äôll use the prog/run switch to disconnect it while programming our Arduino</li>\n<li>If in the future we design our own circuits, we‚Äôll use a microcontroller with multiple UARTS so MIDI can be on its own</li>\n</ol>\n<h2>Sketch #2: MIDI CC Controller</h2>\n<p><a href=\"https://github.com/handeyeco/fun-with-midi/blob/main/cc-controller/cc-controller.ino\">Source code</a></p>\n<p>I‚Äôm not going to explain MIDI or MIDI CC in a lot of detail. You have access to the internet. I‚Äôm just going to say that MIDI is how digital music devices communicate with one another and MIDI CC is how we control parameters on one device from another device.</p>\n<p>This script will give us the power to change parameters on a remote device from our Arduino. Imagine being able to change the filter cutoff on your synth from the other side of the room - that <em>can</em> be a reality for you!</p>\n<p>The code is much more concise as it takes the last example and cuts a lot away from it. We‚Äôre only going to use the pots here:</p>\n<ul>\n<li>One pot will control which CC we‚Äôre modifying. For instance on the Hydrasynth, filter 1 cutoff is MIDI CC 74 and LFO 1 rate is MIDI CC 72. Your synth‚Äôs manual should tell you what CC controls what parameter.</li>\n<li>The other pot will control the value of the MIDI CC. Most of MIDI works with 7 bits which gives us a range between 0 and 127 (128 steps).</li>\n</ul>\n<p>First we import <a href=\"https://github.com/FortySevenEffects/arduino_midi_library\">FortySevenEffects‚Äô MIDI library</a> and initialize it:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;MIDI.h></span></span>\n\n<span class=\"token function\">MIDI_CREATE_DEFAULT_INSTANCE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We set pins and initalize state like before; this time though we also have to start the MIDI library. Additionally I‚Äôve added a helper function to map 0-1023 (the full range that an Arduino‚Äôs <code class=\"language-text\">analogRead</code> can supply) to 0-127 (the full range that MIDI can use).</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// pot pins</span>\nbyte RV1_PIN <span class=\"token operator\">=</span> A1<span class=\"token punctuation\">;</span>\nbyte RV2_PIN <span class=\"token operator\">=</span> A0<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// declare read state</span>\n<span class=\"token keyword\">int</span> RV1_STATE <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> RV2_STATE <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">read_and_map</span><span class=\"token punctuation\">(</span>byte pin<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> read <span class=\"token operator\">=</span> <span class=\"token function\">analogRead</span><span class=\"token punctuation\">(</span>pin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">map</span><span class=\"token punctuation\">(</span>read<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1023</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">127</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  MIDI<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span>MIDI_CHANNEL_OMNI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// set pin modes</span>\n  <span class=\"token function\">pinMode</span><span class=\"token punctuation\">(</span>RV1_PIN<span class=\"token punctuation\">,</span> INPUT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pinMode</span><span class=\"token punctuation\">(</span>RV2_PIN<span class=\"token punctuation\">,</span> INPUT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// initialize read state</span>\n  RV1_STATE <span class=\"token operator\">=</span> <span class=\"token function\">read_and_map</span><span class=\"token punctuation\">(</span>RV1_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  RV2_STATE <span class=\"token operator\">=</span> <span class=\"token function\">read_and_map</span><span class=\"token punctuation\">(</span>RV2_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now the juicy bit:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// there are 16 MIDI channels,</span>\n<span class=\"token comment\">// I just used the first one</span>\nbyte MIDI_CH <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// read pins</span>\n  <span class=\"token keyword\">int</span> RV1_READ <span class=\"token operator\">=</span> <span class=\"token function\">read_and_map</span><span class=\"token punctuation\">(</span>RV1_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> RV2_READ <span class=\"token operator\">=</span> <span class=\"token function\">read_and_map</span><span class=\"token punctuation\">(</span>RV2_PIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// RV1 adjusts which CC channel we're changing</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>RV1_READ <span class=\"token operator\">!=</span> RV1_STATE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    RV1_STATE <span class=\"token operator\">=</span> RV1_READ<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// RV2 adjusts the CC value</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>RV2_READ <span class=\"token operator\">!=</span> RV2_STATE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    RV2_STATE <span class=\"token operator\">=</span> RV2_READ<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// sendControlChange(CC, value, channel)</span>\n    MIDI<span class=\"token punctuation\">.</span><span class=\"token function\">sendControlChange</span><span class=\"token punctuation\">(</span>RV1_STATE<span class=\"token punctuation\">,</span> RV2_STATE<span class=\"token punctuation\">,</span> MIDI_CH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>What this sketch does:</p>\n<ul>\n<li>It watches for changes on the RV1 potentiometer and if it changes we change the MIDI CC we‚Äôre going to adjust</li>\n<li>It watches for changes on the RV2 potentiometer and if it changes we send a MIDI CC message to our MIDI output using the MIDI CC from RV1 and the value from RV2</li>\n</ul>\n<p>In theory we could use RV1 to go to MIDI CC 74 then use RV2 to adjust the filter cutoff on our Hydrasynth. Or use RV1 to go to MIDI CC 81 then use RV2 to adjust envelope 1 attack.</p>\n<p>In practice this is a little tough because we don‚Äôt have a display to tell us what MIDI CC we‚Äôre on. For now we could use an app like MIDI Monitor to see our work in action and later we could add a cheap I2C OLED screen to tell us what‚Äôs happening.</p>\n<h2>Sketch #3: Random CC</h2>\n<p><a href=\"https://github.com/handeyeco/fun-with-midi/blob/main/random-cc/random-cc.ino\">Source code</a></p>\n<p>Let‚Äôs go one step further and make something that‚Äôs actually fun to use without adding a screen or connecting it to a computer. Modular folks think they have all the fun with their bleeps and their bloops and their endless modulation options, but now that we know we can control synths using MIDI CC, we can make our own obnoxious sounds!</p>\n<p>Here‚Äôs what this sketch is going to do:</p>\n<ul>\n<li>We‚Äôre going to pick a MIDI CC and start sending it random values.</li>\n<li>RV2 will determine how often we send a random value: really fast or really slow.</li>\n<li>\n<p>RV1 will do different things based on the buttons:</p>\n<ul>\n<li>When we press S3 we‚Äôll turn off all the LEDs and RV1 will change the offset of the MIDI CC. MIDI CC works between 0 and 127; offset will set the lowest possible value our random CC generator will send.</li>\n<li>When we press S4 we‚Äôll turn on the green LED and RV1 will now change the depth of the MIDI CC. This essentially will set the highest possible value our random CC generator will send.</li>\n<li>When we press S5 we‚Äôll turn on the red LED and RV1 will now change the MIDI CC that we‚Äôre sending to. Basically chosing what parameter we want to control.</li>\n</ul>\n</li>\n</ul>\n<p>So when ‚Äúoffset‚Äù is 0 and ‚Äúdepth‚Äù is 127, we‚Äôll get random CCs between 0 and 127. When ‚Äúoffset‚Äù is 64 and ‚Äúdepth‚Äù is 127, we‚Äôll get random CCs between 64 and 127 (we‚Äôll clamp the maximum output to 127 since that‚Äôs the max MIDI CC can handle). When ‚Äúoffset‚Äù is 64 and ‚Äúdepth‚Äù is 10, we‚Äôll get random CCs between 64 and 74.</p>\n<p>So by default we‚Äôll generate random CCs using the full CC range:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/06abf80ea7eb47c0ac6039f63969c6d3/26162/wide-scatter.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA/0lEQVQoz51SQRKEIAzj/6/1oKOWFJZAi5Xd0zoTxdKGNDRd11W3bevY973yKaX8jcQXSQFUVe1BaANGghJq6/bN0Ll2krnfCYemFqidiJsaTkQneavQ8s5Ry5sK7/vu6hAUEFxf8iiCdSAt7mpdHawuUR/JqCK28aUoKNcAV1bdQ/pHhbFYjHw9gMWSh7/Qt393HmrTeZ71bKROACMTK9JgfDyAee4twt5seV6IE4dWshXHS3MbfN/XaZyObjgsuJK6Io/NkdKHzJE4MrnN4HoRY5QeX/kfEX3VkP/cckYfbpIjYMbbV/J3PNaQJ412mJBfRCuO46gi8pPQ/0n4AfqmtpnPAT66AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Scatter plot of a wide CC range\"\n        title=\"Scatter plot of a wide CC range\"\n        src=\"/tech-blog/static/06abf80ea7eb47c0ac6039f63969c6d3/fcda8/wide-scatter.png\"\n        srcset=\"/tech-blog/static/06abf80ea7eb47c0ac6039f63969c6d3/12f09/wide-scatter.png 148w,\n/tech-blog/static/06abf80ea7eb47c0ac6039f63969c6d3/e4a3f/wide-scatter.png 295w,\n/tech-blog/static/06abf80ea7eb47c0ac6039f63969c6d3/fcda8/wide-scatter.png 590w,\n/tech-blog/static/06abf80ea7eb47c0ac6039f63969c6d3/efc66/wide-scatter.png 885w,\n/tech-blog/static/06abf80ea7eb47c0ac6039f63969c6d3/c83ae/wide-scatter.png 1180w,\n/tech-blog/static/06abf80ea7eb47c0ac6039f63969c6d3/26162/wide-scatter.png 2020w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>But we can narrow that range using offset and depth:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/15d52dbcd90e019fd64995ecc836fe69/26162/narrow-scatter.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAsElEQVQoz61SSRLDIAzL/19LLmHzUmQDTXtgOiXMCOMlQiY+UkoaQtDzPM0ys4rI3ziwgZSIjGybUNsyR33tkE2FOWeVTWUfCtEmUWu9iNZmiaXF3JbqZwC50mF1DSxv3wjxflA4yHJ14lS4w0lxzjdbbnUjj++PGKPGmKYK+gJiUxG7Ist1f8RHbrb8xPvNn+Ij8zAh7Gpsfh2p2XKt1Yh3AJ7b2KwLr+uyS1e1yL0AmXe2jS+bmAwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Scatter plot of a narrow CC range\"\n        title=\"Scatter plot of a narrow CC range\"\n        src=\"/tech-blog/static/15d52dbcd90e019fd64995ecc836fe69/fcda8/narrow-scatter.png\"\n        srcset=\"/tech-blog/static/15d52dbcd90e019fd64995ecc836fe69/12f09/narrow-scatter.png 148w,\n/tech-blog/static/15d52dbcd90e019fd64995ecc836fe69/e4a3f/narrow-scatter.png 295w,\n/tech-blog/static/15d52dbcd90e019fd64995ecc836fe69/fcda8/narrow-scatter.png 590w,\n/tech-blog/static/15d52dbcd90e019fd64995ecc836fe69/efc66/narrow-scatter.png 885w,\n/tech-blog/static/15d52dbcd90e019fd64995ecc836fe69/c83ae/narrow-scatter.png 1180w,\n/tech-blog/static/15d52dbcd90e019fd64995ecc836fe69/26162/narrow-scatter.png 2020w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This code shares a lot from the first two examples, so I‚Äôm just going to talk about the important changes. First we initialize some state:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// what editing mode we're in:</span>\n<span class=\"token comment\">// 0 = offset (no LEDs)</span>\n<span class=\"token comment\">// 1 = depth (green LED)</span>\n<span class=\"token comment\">// 2 = CC (red LED)</span>\nbyte RV1_edit_mode <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// offset is our lowest possible CC</span>\n<span class=\"token keyword\">int</span> offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// depth is how far from</span>\n<span class=\"token comment\">// the lowest CC we can go</span>\n<span class=\"token keyword\">int</span> depth <span class=\"token operator\">=</span> <span class=\"token number\">127</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// the MIDI CC we're sending values for</span>\n<span class=\"token comment\">// 74 is commonly the CC for filter cutoff</span>\nbyte cc <span class=\"token operator\">=</span> <span class=\"token number\">74</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// these are used to set our</span>\n<span class=\"token comment\">// MIDI message interval</span>\n<span class=\"token keyword\">int</span> MIN_SPEED <span class=\"token operator\">=</span> <span class=\"token number\">60</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> MAX_SPEED <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> speed <span class=\"token operator\">=</span> MAX_SPEED<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> last_cc_sent <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Next we check each button to see if they have been pressed and if we detect a change we update the mode we‚Äôre in, for example:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">  byte old_RV1_edit_mode <span class=\"token operator\">=</span> RV1_edit_mode<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// update edit state if button change detected</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>S3_READ <span class=\"token operator\">!=</span> S3_STATE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    S3_STATE <span class=\"token operator\">=</span> S3_READ<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// set RV1_edit_mode to offset</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>S3_STATE <span class=\"token operator\">==</span> LOW<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      RV1_edit_mode <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// ...similar for the other buttons...</span>\n\n  <span class=\"token comment\">// watch for changes to edit mode and update LEDs</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>old_RV1_edit_mode <span class=\"token operator\">!=</span> RV1_edit_mode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">digitalWrite</span><span class=\"token punctuation\">(</span>GRN_LED_PIN<span class=\"token punctuation\">,</span> RV1_edit_mode <span class=\"token operator\">!=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">digitalWrite</span><span class=\"token punctuation\">(</span>RED_LED_PIN<span class=\"token punctuation\">,</span> RV1_edit_mode <span class=\"token operator\">!=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then we read the pots. For RV1, we update the settings based on what mode we‚Äôre in. For RV2, we map the read value between our min/max interval speed:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">  <span class=\"token comment\">// if RV1 changes, look at the edit mode</span>\n  <span class=\"token comment\">// to determine which setting should be updated</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>RV1_READ <span class=\"token operator\">!=</span> RV1_STATE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    RV1_STATE <span class=\"token operator\">=</span> RV1_READ<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>RV1_edit_mode <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      offset <span class=\"token operator\">=</span> RV1_STATE<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>RV1_edit_mode <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      depth <span class=\"token operator\">=</span> RV1_STATE<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>RV1_edit_mode <span class=\"token operator\">==</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      cc <span class=\"token operator\">=</span> RV1_STATE<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// use RV2 to update the speed of the interval</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>RV2_READ <span class=\"token operator\">!=</span> RV2_STATE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    RV2_STATE <span class=\"token operator\">=</span> RV2_READ<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// we map pot reads from 0-1023 to 0-127 for MIDI</span>\n    <span class=\"token comment\">// but now we're mapping 0-127 to MIN/MAX_SPEED</span>\n    speed <span class=\"token operator\">=</span> <span class=\"token function\">map</span><span class=\"token punctuation\">(</span>RV2_STATE<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">127</span><span class=\"token punctuation\">,</span> MIN_SPEED<span class=\"token punctuation\">,</span> MAX_SPEED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Finally we continuously check to see if the current timestamp minus the timestamp for the last message is larger than our interval; if so, send a new message:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">  <span class=\"token comment\">// 1. check the current time</span>\n  <span class=\"token comment\">// 2. compare it to the last time we sent a message</span>\n  <span class=\"token comment\">// 3. if we're past our interval, send a new message</span>\n  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> now <span class=\"token operator\">=</span> <span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>now <span class=\"token operator\">-</span> last_cc_sent <span class=\"token operator\">></span> speed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    last_cc_sent <span class=\"token operator\">=</span> now<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// max is offset + depth, as long as it's between 0 and 127</span>\n    <span class=\"token keyword\">int</span> max_val <span class=\"token operator\">=</span> <span class=\"token function\">constrain</span><span class=\"token punctuation\">(</span>offset <span class=\"token operator\">+</span> depth<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">127</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> rand_val <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span>offset<span class=\"token punctuation\">,</span> max_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// sendControlChange(CC, value, channel)</span>\n    MIDI<span class=\"token punctuation\">.</span><span class=\"token function\">sendControlChange</span><span class=\"token punctuation\">(</span>cc<span class=\"token punctuation\">,</span> rand_val<span class=\"token punctuation\">,</span> MIDI_CH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Adding MIDI in</h2>\n<p>Addind MIDI in isn‚Äôt too much work either, it‚Äôs just that the MIDI specification require the use of an optocoupler to electrically isolate the receiving circuit from the sending circuit. Looking at the Sparkfun schematic, the important pieces are:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/fa64f6b8ca55a94a9d5085d5870fc2b3/ec09f/midi-in-schematic.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 87.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAACdElEQVQ4y52UW2/TQBCF8///BY9IvEBvqqCCXoKoUNOkLSGRkjqp716vd+31rp205TDehCQtCEgfRmvt2p/PzJydljESRSlQagm9EcYU8DlDmmfggj05W7+T29jca9VVAZeFyHKOulaoCFRVCqUMcTe9ROD0wGIH2p6tPzYUjQi1fF4BMxUjHn4D9x3E2RRhOgUvOfjkHI96H9J5h7vbPp1PwESyVCTsKvMUPIuf/Ki1eoEUsMkA49E1OO2x/gmy4Ssk3deQkQdvdINp4tpSaKNoLVEqgVwyGMpoDdQ5MpZgNjfgRUQRIqcDEfZQiwMkV28QhyNkhoGrCCpPUMTfkTodBMNzsGkHpkjoJ8UCyMdDxP0rCNexwJLUNjXURQqVeSiEDx67mNGe0CmEP8T97Ah6fgRWvqcy7UIlA1JZ2kxbyeAGivnwrroQBNFmWeCmgwRRlEHAI1t4WWXwe21Moj3o+2P8wBk8vg9+11uUgNzSylkA5t7aD8xS9p/s0az1TMO/OIOb7OERp3igiLID8GnXAq3CgMcYRS7cNIQqxW++2oyKgB4BI1IFtC00oTo39VwBNxX8K6qagF9Pl8AzG1IdIhp8IetsAPUzc/5NYZNyQmkugG2I/ABe5yM18hlQ/ycw6LTJ/AuF5uEE03gHfvfYAm1TtgLWJaV8AifcscByfkzXdhdsfLG2zbbAeHiJSB4S8DPk/BPGpDC6IbVGbQ9sfFnQXb9XH+D5O+hP3kKShWTQp8FiXgAkN5SKQ4sAk0Ebzm0HYTyhxjRjLkWusu2AqxlIStPER0kXIZacvMgQ0tSRxQuAvyIiQNPVZnTZqBa37Cf/r063Hh6N2AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Schematic of MIDI in circuit\"\n        title=\"Schematic of MIDI in circuit\"\n        src=\"/tech-blog/static/fa64f6b8ca55a94a9d5085d5870fc2b3/fcda8/midi-in-schematic.png\"\n        srcset=\"/tech-blog/static/fa64f6b8ca55a94a9d5085d5870fc2b3/12f09/midi-in-schematic.png 148w,\n/tech-blog/static/fa64f6b8ca55a94a9d5085d5870fc2b3/e4a3f/midi-in-schematic.png 295w,\n/tech-blog/static/fa64f6b8ca55a94a9d5085d5870fc2b3/fcda8/midi-in-schematic.png 590w,\n/tech-blog/static/fa64f6b8ca55a94a9d5085d5870fc2b3/efc66/midi-in-schematic.png 885w,\n/tech-blog/static/fa64f6b8ca55a94a9d5085d5870fc2b3/c83ae/midi-in-schematic.png 1180w,\n/tech-blog/static/fa64f6b8ca55a94a9d5085d5870fc2b3/ec09f/midi-in-schematic.png 1916w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>R5 is limiting current</li>\n<li>R6 is a pull-up resistor</li>\n<li>D3 is protection again reverse polarization</li>\n<li>The 6N138 is sending the data from two electrically disconnected circuits</li>\n</ul>\n<p>To have both hardware MIDI in and MIDI out, you‚Äôre looking at eight cheap and highly available components (not including the Arduino). No vactrols, no germanium transistors, no archaic ICs you have to source from estate sales.</p>\n<h2>Closing thoughts</h2>\n<p>The fun thing about this circuit is that you don‚Äôt have to control just one thing on one device:</p>\n<ul>\n<li>Traditional MIDI CC lets you control 127 parameters</li>\n<li>MIDI NRPN lets you control 16,383 parameters</li>\n<li>Thanks to MIDI channels, you can simultaneously control up to 16 devices</li>\n</ul>\n<p>We‚Äôre not just limited to parameter changes either, with MIDI you can:</p>\n<ul>\n<li>Control the clock that devices use</li>\n<li>Send program changes to jump between patches on the fly</li>\n<li>Send traditional notes but also microtonal notes now thanks to MIDI MPE</li>\n</ul>\n<p>If you‚Äôre interested in open-source MIDI projects, be sure to check out:</p>\n<ul>\n<li><a href=\"https://monome.org/docs/norns/\">Norns</a></li>\n<li><a href=\"https://cs.gmu.edu/~sean/projects/gizmo/\">Gizmo</a></li>\n<li><a href=\"https://www.midigoblin.com/\">MIDI Goblin</a></li>\n<li><a href=\"https://github.com/pichenettes/midipal\">Midipal</a></li>\n</ul>\n<p>Finally, I‚Äôm working on an open-source generative sequencer called <a href=\"https://github.com/handeyeco/Grandbot\">Grandbot</a>.</p>","frontmatter":{"title":"Fun with MIDI","date":"February 27, 2025","description":"Playing with MIDI circuits and code for beginners."}}},"pageContext":{"slug":"/fun-with-midi/","previous":{"fields":{"slug":"/nano-midipal/"},"frontmatter":{"title":"Midipal on the Arduino Nano"}},"next":{"fields":{"slug":"/eleventy-date/"},"frontmatter":{"title":"11ty Off-By-One Date"}}}},"staticQueryHashes":["63159454"]}