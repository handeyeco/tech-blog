{"componentChunkName":"component---src-templates-blog-post-js","path":"/nano-midipal/","result":{"data":{"site":{"siteMetadata":{"title":"Tech Blog"}},"markdownRemark":{"id":"8c749f82-7020-5d29-a83a-837884110bc4","excerpt":"Disclaimer: I don’t know what I’m talking about. I’m a JavaScript dev who’s just learning this stuff too. I’m sharing what I think I learned, but that doesn’t…","html":"<p><em><strong>Disclaimer:</strong> I don’t know what I’m talking about. I’m a JavaScript dev who’s just learning this stuff too. I’m sharing what I <strong>think</strong> I learned, but that doesn’t make it the truth.</em></p>\n<p><strong>I have not succeeded, this is a WIP and might never be finished. Please let me know if you make more progress than I did.</strong></p>\n<h2>The Goal</h2>\n<p>If you’ve ever read anything on this blog, it’s obvious I’m going through a MIDI phase right now. After working for awhile on <a href=\"https://github.com/handeyeco/Grandbot\">Grandbot</a>, I’ve started thinking about what I want to do next and I was thinking of a MIDI utility tool.</p>\n<p>One Saturday morning I was reading about Mutable Instrument’s <a href=\"https://pichenettes.github.io/mutable-instruments-diy-archive/midipal/manual/\">Midipal</a> and realized the microcontroller used was an ATmega328P, the same MCU as the Arduino Nano (and Arduino Uno). I had an extra 16x2 display from working on the <a href=\"https://github.com/handeyeco/minidexed-pcb\">MiniDexed PCB</a> and some leftover Nanos from working on Grandbot, so I thought it would be a fun weekend project to try and get Midipal running on a Nano.</p>\n<p>I wanted to share my findings so that SynthDIY newbies would have an easy project to build (had I succeeded, which I didn’t).</p>\n<h2>The Schematic</h2>\n<p>I couldn’t actually open the Midipal schematics because they’re EAGLE files. I ended up looking at the schematics of forks and reading through the code for the pins. Here’s what I came up with.</p>\n<p>The main UI schematic:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/e0f010e7014ba4c16822676e1732c27d/0ff19/ui-schematic.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 85.8108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAAC0klEQVQ4y31U6VLbMBjM+/cx+gCdAcpAoQVKgRlmKJQrzkHinD5kSb7tlGO7kskUGugPjRLJ2m+/3ZVaRRHjrZHnGnmhUb5YK8sYVZmg5ijfOddaWSxT1IsCaZFAaoGqSu26mVPOoVbwOTLum7WS85uApalKsDwOoMYOwu4F5LSDkocMWz+YYjy5w7j7He7NDn/34YvZ2wwN/SQR0DJCLs+Ql18g9DZEuIVcTC3rNFOIgwmi84+YbX+AN7rFYN5HnASWzGtALrSda3TbV3B7XyEXX1E/HeJq+AnKJcs6R1VniIIxtOcgDbtkrUgiQkDmK4B1nWLo9uDc/sKwu4sF9vGIQ8TxDhKClFVmDRE6pI4pwYtGWwIleWPcErS1FNwd9dFxLjFob+M3DgD8QBhuIho4qGhSwYOVPaTtkJTIFDGOG40V2b5gmKHXb8O5usDodusZ8AihvwH/5hz1ffkMmNriVZlDeDMMOYzzZi/WAWruNQzZ8swfYdC9wfByA+XTPgGPEXgEvG4AbcvSQ0hj1PSMeh5j0D+AJ/g/HGNGuWQq0TJVZeJBFSEkP+5drCN93CPgCTxvDR4ZmpYFD439AUYjB9PhJirsoYqZBs+FJjvf7RKHgEZQQf28yQDjQRdifsos7mI4WkPs7yKP5jaLQgVWo1RTK3mE/GGfRq4j7F8ho+Na+VaOlkm6ZkATLsSRZ3XItI+5e4tpOIOvQgR0NyfY4r5AJnyMnA08MAWL9BsEzxpDZCwaU2z1O7bB2EyooaLAaaqoV8CAMxYMdGruNUcg5pjRPLfz2cbKAGaZtPGplrExgDqcQLI1E9wsbwKamXyVyyvZfNzuXOPm5wmm/Q3cMwl1tosiiyzgq2CHkQ/FtqRqrC9eBPXl0GxLskU5PWXxQyT+CSOjVgEz81w9z+89S8sLYF+YktfQmyBL1Erh1t+XJvkv2OsnzjxjjVH/Av4BFw/+AGBjuykAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Schematic for Arduino, LCD, and encoder\"\n        title=\"Schematic for Arduino, LCD, and encoder\"\n        src=\"/tech-blog/static/e0f010e7014ba4c16822676e1732c27d/fcda8/ui-schematic.png\"\n        srcset=\"/tech-blog/static/e0f010e7014ba4c16822676e1732c27d/12f09/ui-schematic.png 148w,\n/tech-blog/static/e0f010e7014ba4c16822676e1732c27d/e4a3f/ui-schematic.png 295w,\n/tech-blog/static/e0f010e7014ba4c16822676e1732c27d/fcda8/ui-schematic.png 590w,\n/tech-blog/static/e0f010e7014ba4c16822676e1732c27d/efc66/ui-schematic.png 885w,\n/tech-blog/static/e0f010e7014ba4c16822676e1732c27d/c83ae/ui-schematic.png 1180w,\n/tech-blog/static/e0f010e7014ba4c16822676e1732c27d/0ff19/ui-schematic.png 2084w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This is roughly the MIDI schematic (not exact, I just have a stripboard with everything I need for Arduino MIDI on it and I don’t remember the exact values):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/234c5332198669b73d7642b5f35da08a/a3c4c/midi-schematic.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 83.78378378378379%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAACYElEQVQ4y4VUyW7bMBDV/39Eb7300ktPQY9tgRZNgCaxm0SJN0ncxUWilgAFXodMHGSB48NAJk2+mffmDYth8DgU4xgwTR1cMNBOYaL1e+dTFK8B5sdL4xDgeoW+0+i6Fs7yDH4UMB2a5x4zfTvaYF7ni3EKkK6GlA16KyH4Jv8/HgO0dLhpNmidhGs57m6WiH2LwLbgyz+QisHXK6xpXxD1+QjtItExmsMGBasqdATOt3dofv9EZzj46S+qbos4uEcpjlS4F34aO4z0He8jYvQIooYncC8qOhiyvs/BUoOmJ70PNCVHdDlBS/Q2zRaht7R+STMBtU4TK/Om88Uhu3iSQnmTAcd9JaPPGqa10lXu/kHAkTo9jG8rGZ8nISmYNSRLj1VzDiUrxJzglW2mmSjWVdYuWShdLvkOHa3vp/jgTzoneYnr8pTcUEHvbrC+vYbpX1ZZKFtD/72AurqEWpzDUKdtEBDLC2i+Anc7+MHAyA0G+RX/wheYyxPUZkPGl3kAUhF70xdM7yAXF4jkQ3W1gGaJBlmEtAu6QXn2HZdyC7Eroc8/wSw/wK++QXQCLFDTogEjz2rNHgD9QJNB1NTmFj1NyUy2SVmnqScJLJi+g6IRlGKNKE7QbT+C/fgMHhhqt4LpGCwV4+lukqYwHYcnHVamQUtzGweL/jE8ZbdRPenYmxKDvYI3a4TJwZU3YOTXmPqwp9z2goAEdOCUjX6TLnkvfWmdKKWKc6cz8JA7K7sG1W4BYRhZyz1Zq0gT8l6Mb2bX5YhkFUnaprl//goVx56jQ5GSMXo4XGhfJP0PS+QKgmyZjj0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Schematic for Arduino MIDI I/O\"\n        title=\"Schematic for Arduino MIDI I/O\"\n        src=\"/tech-blog/static/234c5332198669b73d7642b5f35da08a/fcda8/midi-schematic.png\"\n        srcset=\"/tech-blog/static/234c5332198669b73d7642b5f35da08a/12f09/midi-schematic.png 148w,\n/tech-blog/static/234c5332198669b73d7642b5f35da08a/e4a3f/midi-schematic.png 295w,\n/tech-blog/static/234c5332198669b73d7642b5f35da08a/fcda8/midi-schematic.png 590w,\n/tech-blog/static/234c5332198669b73d7642b5f35da08a/efc66/midi-schematic.png 885w,\n/tech-blog/static/234c5332198669b73d7642b5f35da08a/c83ae/midi-schematic.png 1180w,\n/tech-blog/static/234c5332198669b73d7642b5f35da08a/a3c4c/midi-schematic.png 2196w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Getting Started</h2>\n<p>First <code class=\"language-text\">git clone https://github.com/pichenettes/midipal</code>.</p>\n<p><code class=\"language-text\">.gitmodules</code> needs to be updated to use <code class=\"language-text\">https://</code> urls instead of <code class=\"language-text\">git://</code> urls:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[submodule &quot;avrlib&quot;]\n\tpath = avrlib\n\turl = https://github.com/pichenettes/avril.git\n[submodule &quot;tools&quot;]\n\tpath = tools\n\turl = https://github.com/pichenettes/avril-firmware_tools.git</code></pre></div>\n<p>Then:</p>\n<ul>\n<li><code class=\"language-text\">git submodule init</code></li>\n<li><code class=\"language-text\">git submodule update</code></li>\n<li><code class=\"language-text\">make</code></li>\n</ul>\n<h2>Problem: CrossPack and Microchip Technology’s Acquisition of Atmel</h2>\n<p><a href=\"https://github.com/obdev/CrossPack-AVR\">CrossPack-AVR</a> seems to have been a helper for fetching the AVR toolchain. It hardcodes the location of the distribution to <code class=\"language-text\">http://distribute.atmel.no/tools/opensource/Atmel-AVR-GNU-Toolchain/$atmelToolchainVersion</code>. However Atmel was aquired by Microchip Technologies and that link no longer works.</p>\n<p>You can see in Midipal what dependencies we wanted:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// makefile.mk</span>\n\nCC             <span class=\"token operator\">=</span> $<span class=\"token punctuation\">(</span>AVRLIB_TOOLS_PATH<span class=\"token punctuation\">)</span>avr<span class=\"token operator\">-</span>gcc\nCXX            <span class=\"token operator\">=</span> $<span class=\"token punctuation\">(</span>AVRLIB_TOOLS_PATH<span class=\"token punctuation\">)</span>avr<span class=\"token operator\">-</span>g<span class=\"token operator\">++</span>\nOBJCOPY        <span class=\"token operator\">=</span> $<span class=\"token punctuation\">(</span>AVRLIB_TOOLS_PATH<span class=\"token punctuation\">)</span>avr<span class=\"token operator\">-</span>objcopy\nOBJDUMP        <span class=\"token operator\">=</span> $<span class=\"token punctuation\">(</span>AVRLIB_TOOLS_PATH<span class=\"token punctuation\">)</span>avr<span class=\"token operator\">-</span>objdump\nAR             <span class=\"token operator\">=</span> $<span class=\"token punctuation\">(</span>AVRLIB_TOOLS_PATH<span class=\"token punctuation\">)</span>avr<span class=\"token operator\">-</span>ar\nSIZE           <span class=\"token operator\">=</span> $<span class=\"token punctuation\">(</span>AVRLIB_TOOLS_PATH<span class=\"token punctuation\">)</span>avr<span class=\"token operator\">-</span>size\nNM             <span class=\"token operator\">=</span> $<span class=\"token punctuation\">(</span>AVRLIB_TOOLS_PATH<span class=\"token punctuation\">)</span>avr<span class=\"token operator\">-</span>nm\nAVRDUDE        <span class=\"token operator\">=</span> $<span class=\"token punctuation\">(</span>AVRLIB_TOOLS_PATH<span class=\"token punctuation\">)</span>avrdude</code></pre></div>\n<p>If you have the Arduino IDE installed, you should pretty much have all this stuff on your computer already. Unfortunately it’s probably not the <code class=\"language-text\">3.5.4</code> version of the toolchain that Midipal uses.</p>\n<p>What I ended up doing was <code class=\"language-text\">brew install avrdude</code>, downloaded the <code class=\"language-text\">3.7.0</code> toolchain <a href=\"https://www.microchip.com/en-us/tools-resources/develop/microchip-studio/gcc-compilers\">from here</a>, updated the <code class=\"language-text\">makefile.mk</code> to point to the directory with the <code class=\"language-text\">3.7.0</code> toolchain, and made a small tweak to <code class=\"language-text\">makefile.mk</code> for <code class=\"language-text\">avrdude</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">- AVRDUDE        = $(AVRLIB_TOOLS_PATH)avrdude\n+ AVRDUDE        = avrdude</code></pre></div>\n<p>At this point I got a little further with <code class=\"language-text\">make</code> except after that I was getting compilation errors due to incompatibilities between the 3.5.4 and 3.7.0 toolchains. I needed to change a few things in the code:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// &gt;&gt; midipal/resources.h\n\n- extern const prog_char* string_table[];\n+ extern const prog_char* const string_table[];\n\n- extern const prog_uint16_t* lookup_table_table[];\n+ extern const prog_uint16_t* const lookup_table_table[];\n\n// &gt;&gt; midipal/resources.cc\n\n- PROGMEM const prog_char* string_table[]\n+ const prog_char* const string_table[] PROGMEM\n\n- PROGMEM const prog_uint16_t* lookup_table_table[]\n+ const prog_uint16_t* const lookup_table_table[] PROGMEM\n\n// &gt;&gt; avrlib/devices/pot_scanner.h\n\n+ #include &lt;string.h&gt;</code></pre></div>\n<p>At this point I think things were basically compiling.</p>\n<h2>Problem: the Clock</h2>\n<p>While debugging issues, someone on Reddit pointed out a possible problem that I was going to have: Midipal was using a 20Mhz clock and the Nano uses a 16Mhz clock. I’m not totally sure how big of an impact that would have but the Midipal code does make a couple of references to the fact that the clock is running at 20Mhz, so I imagine it would have <em>some</em> impact.</p>\n<h2>Problem: the Bootloader</h2>\n<p>One of the big things I learned while doing this is that you can’t program the 328’s bootloader over USB. The bootloader is the code that runs when the microcontroller boots and I believe that it needs to be written to the microcontroller via ICSP.</p>\n<p>Why does the bootloader matter? It’s my understanding that the bootloader is what helps the Arduino accept firmware over USB and the Midipal’s bootloader cleverly accepts firmware via MIDI. Put a different way, this is what lets Midipal accept alternative firmware over MIDI.</p>\n<p>Unfortunately this makes having the full Midipal experience on the Nano much more difficult: people would need an ICSP programmer or a second Arduino that could work as an ICSP programmer.</p>\n<p>On top of this, Midipal is manipulating the fuses on the 328. <strong>This makes the whole thing a lot more risky to newbies because a simple mistake could brick the MCU.</strong></p>\n<h2>Installing the firmware without the bootloader</h2>\n<p>Just out of curiosity though, I pressed on. At this point I had a <code class=\"language-text\">midipal.hex</code> (which I believe is the firmware) and <code class=\"language-text\">muboot.hex</code> (which I think is the bootloader), so I thought: why don’t I just try to send the firmware to the Arduino without the bootloader and see what happens?</p>\n<p>I made a test script in the Arduino IDE, turned on “show verbose output during compile and upload” in the settings, and sent the script to the Nano. That gave me a command that I then modified to point at <code class=\"language-text\">midipal.hex</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&quot;/Users/me/Library/Arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude&quot; /\n    &quot;-C/Users/me/Library/Arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/etc/avrdude.conf&quot; /\n    -v -V -patmega328p -carduino &quot;-P/dev/cu.usbserial-310&quot; -b115200 -D /\n    &quot;-Uflash:w:/Users/me/code/_backups/mutable-instruments/midipal/build/midipal/midipal.hex:i&quot;</code></pre></div>\n<p>Surprisingly…that kinda worked…in the sense that the display was showing the Midipal UI and the encoder navigated around. It’s pretty janky and it’s not handling MIDI correctly - maybe having to do with the clock? It receives and sends MIDI, but the MIDI it’s sending is random/erratic. To be honest, I was shocked to get this far.</p>\n<h2>Where things stand</h2>\n<ul>\n<li>I’m not convinced this will ever work at all due to the clock (without maintaining a fork of the repo)</li>\n<li>Some of the fun features of Midipal depends on a custom bootloader, so I don’t think this would be a good beginner project</li>\n<li><a href=\"https://cs.gmu.edu/~sean/projects/gizmo/\">Gizmo</a> exists, is easy to make, and is probably more feature-rich than Midipal</li>\n</ul>\n<p>I might keep hacking away at this just as a learning experience, but right now I’m considering this a failed project. It’s important to share the failures too though! Hopefully it’ll save someone some trouble.</p>","frontmatter":{"title":"Midipal on the Arduino Nano","date":"February 26, 2025","description":"Failed attempt to get the Mutable Instruments Midipal firmware running on an Arduino Nano."}}},"pageContext":{"slug":"/nano-midipal/","previous":{"fields":{"slug":"/cc-bc/"},"frontmatter":{"title":"Creative Commons on Bandcamp"}},"next":{"fields":{"slug":"/fun-with-midi/"},"frontmatter":{"title":"Fun with MIDI"}}}}}