{"componentChunkName":"component---src-templates-blog-post-js","path":"/grandbot-update-sleep/","result":{"data":{"site":{"siteMetadata":{"title":"Tech Blog"}},"markdownRemark":{"id":"f5e2ca87-7c51-59ad-97ba-71800cf7446e","excerpt":"Disclaimer: I don’t know what I’m talking about. I’m a JavaScript dev who’s just learning this stuff too. I’m sharing what I think I learned, but that doesn’t…","html":"<p><em><strong>Disclaimer:</strong> I don’t know what I’m talking about. I’m a JavaScript dev who’s just learning this stuff too. I’m sharing what I <strong>think</strong> I learned, but that doesn’t make it the truth.</em></p>\n<p><em>Project originally inspired by the work of <a href=\"https://twitter.com/MohitBhoite\">Mohit Bhoite</a>.</em></p>\n<p><em>Code references the state as of <a href=\"https://github.com/handeyeco/Grandbot/tree/2020-05-15\">this tag</a>.</em></p>\n<p>The past week has been a big one for the newly named Grandbot project. I finally got to a place where I felt it was time to take a deep dive into C++ and implemented a bunch of new features while learning more about electronics and Arduino programming. Even though the hardware side of things is fairly straightforward, I’m breaking this post into several parts since the code is exponentially more complex now.</p>\n<p>This post is about putting Grandbot to sleep when it gets dark.</p>\n<h2>Adding a photoresistor</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/1332512bf33072f49df30ccd80ee79e7/e018a/schematic.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.45945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBf/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB1JMua5MP/8QAGBABAAMBAAAAAAAAAAAAAAAAAQARIRD/2gAIAQEAAQUC2WkGXjz/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAXEAADAQAAAAAAAAAAAAAAAAAAICFB/9oACAEBAAY/AsKv/8QAGxABAAICAwAAAAAAAAAAAAAAAQARITFBUXH/2gAIAQEAAT8huW+zOs4jpaj4S0cHqKz/2gAMAwEAAgADAAAAELjv/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBABAAMAAgMAAAAAAAAAAAAAAQARIUFRMWGh/9oACAEBAAE/EBxsBxrF6KnCqVXR7jfXYoH2PIiW9btW9y15n//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Schematic of the build\"\n        title=\"Schematic of the build\"\n        src=\"/tech-blog/static/1332512bf33072f49df30ccd80ee79e7/1c72d/schematic.jpg\"\n        srcset=\"/tech-blog/static/1332512bf33072f49df30ccd80ee79e7/a80bd/schematic.jpg 148w,\n/tech-blog/static/1332512bf33072f49df30ccd80ee79e7/1c91a/schematic.jpg 295w,\n/tech-blog/static/1332512bf33072f49df30ccd80ee79e7/1c72d/schematic.jpg 590w,\n/tech-blog/static/1332512bf33072f49df30ccd80ee79e7/a8a14/schematic.jpg 885w,\n/tech-blog/static/1332512bf33072f49df30ccd80ee79e7/fbd2c/schematic.jpg 1180w,\n/tech-blog/static/1332512bf33072f49df30ccd80ee79e7/e018a/schematic.jpg 1876w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<figcaption>Schematic of the build</figcaption>\n<h3>Components</h3>\n<ul>\n<li>Photoresistor (I used an LXD5537; dark 20M Ohm, light 18-50k Ohm)</li>\n<li>10k Ohm resistor</li>\n<li>Arduino Uno</li>\n</ul>\n<h4>Component notes</h4>\n<p>For reading different values (rather than just <code class=\"language-text\">HIGH</code>/<code class=\"language-text\">LOW</code>), we have to use an analog input on the Arduino.</p>\n<p>The resistor is a pull down resistor. I chose 10k Ohm according to <a href=\"https://learn.adafruit.com/photocells/using-a-photocell\">this guide</a> because I’m more concerned with darker values. From that page:</p>\n<blockquote>\n<p>If you’re planning to have the sensor in a bright area and use a 10KΩ pulldown, it will quickly saturate. That means that it will hit the ‘ceiling’ of 5V and not be able to differentiate between kinda bright and really bright. In that case, you should replace the 10KΩ pulldown with a 1KΩ pulldown. In that case, it will not be able to detect dark level differences as well but it will be able to detect bright light differences better. This is a tradeoff that you will have to decide upon</p>\n</blockquote>\n<p><a href=\"https://forum.arduino.cc/index.php?topic=18241.0\">This page</a> was also a helpful resource. From it:</p>\n<blockquote>\n<p>The analogue input is high impedance that means when you connect it to the +5 and the input virtually no current flows. If there is no current flowing through a resistor then there is no voltage drop across it, and so it always reads high.</p>\n<p>The pull down resistor makes current flow through the photo resistor and so different light levels result in different currents and hence different voltages (ohms law) which the analogue input can measure.</p>\n</blockquote>\n<h3>Code</h3>\n<p>The code is still being refined, but the basic idea is that when we’re below a “sleep threshold” we should go to sleep and when we’re above a “wake threshold” we should wake. It’s important that these two thresholds are different. Initially I used a single threshold and when it reached that reading, slight fluctuations in light caused it to continuously switch between on and off. Keeping the two thresholds far away enough from each other allowed the switch to happen without immediately flapping back and forth.</p>\n<p>The code grew quite a bit, which is why I linked to the full code above. I’m just going to show the general concept.</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// main.cpp</span>\n\n<span class=\"token comment\">// Use the Analog 0 pin</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">lightPin</span> <span class=\"token expression\">A0</span></span>\n\n<span class=\"token comment\">// ...set other pins...</span>\n\nGrandbot gb <span class=\"token operator\">=</span> <span class=\"token function\">Grandbot</span><span class=\"token punctuation\">(</span>dataPin<span class=\"token punctuation\">,</span> clockPin<span class=\"token punctuation\">,</span> loadPin<span class=\"token punctuation\">,</span> voicePin<span class=\"token punctuation\">,</span> redPin<span class=\"token punctuation\">,</span> greenPin<span class=\"token punctuation\">,</span> bluePin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token keyword\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> light <span class=\"token operator\">=</span> <span class=\"token function\">analogRead</span><span class=\"token punctuation\">(</span>lightPin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Pass the light reading to Grandbot's update method</span>\n  gb<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>light<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// Grandbot.h</span>\n\nclass <span class=\"token class-name\">Grandbot</span> <span class=\"token punctuation\">{</span>\n    private<span class=\"token operator\">:</span>\n        <span class=\"token keyword\">void</span> <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">void</span> <span class=\"token function\">wakeup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// -1 = uninitialized</span>\n        <span class=\"token comment\">//  0 = sleeping</span>\n        <span class=\"token comment\">//  1 = happy</span>\n        <span class=\"token comment\">//  2 = neutral</span>\n        <span class=\"token comment\">//  3 = unhappy</span>\n        <span class=\"token keyword\">int</span> mood <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// These thresholds need to be different</span>\n        <span class=\"token comment\">// to prevent flapping between on/off</span>\n        static const <span class=\"token keyword\">int</span> wakeThreshold <span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">;</span>\n        static const <span class=\"token keyword\">int</span> sleepThreshold <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>\n    public<span class=\"token operator\">:</span>\n        <span class=\"token function\">Grandbot</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> dataPin<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> clockPin<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> loadPin<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> voicePin<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> redPin<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> greenPin<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> bluePin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">void</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> light<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// Grandbot.cpp</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Grandbot</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> light<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">boolean</span> awake <span class=\"token operator\">=</span> light <span class=\"token operator\">></span> Grandbot<span class=\"token double-colon punctuation\">::</span>wakeThreshold<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">boolean</span> asleep <span class=\"token operator\">=</span> light <span class=\"token operator\">&lt;</span> Grandbot<span class=\"token double-colon punctuation\">::</span>sleepThreshold<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// If mood == sleep and light > wakeThresh: wakeup.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mood <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>awake<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">wakeup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token comment\">// If mood != sleep or uninitialized...</span>\n  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mood <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...and light &lt; sleepThresh: go to sleep.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>asleep<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// ...do other stuff here...</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token comment\">// Otherwise we're uninitialized,</span>\n  <span class=\"token comment\">// so we start in sleep mode.</span>\n  <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Grandbot</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Dim the 4D7S display</span>\n  lc<span class=\"token punctuation\">.</span><span class=\"token function\">setIntensity</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Set mood to sleep</span>\n  <span class=\"token comment\">// and update expression</span>\n  mood <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">setExpression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Grandbot</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">wakeup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Kickstart blinking</span>\n  nextBlink <span class=\"token operator\">=</span> <span class=\"token function\">getNextBlink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  blinkLength <span class=\"token operator\">=</span> <span class=\"token function\">getBlinkLength</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Brighten 4D7S display</span>\n  <span class=\"token comment\">// and update expression</span>\n  lc<span class=\"token punctuation\">.</span><span class=\"token function\">setIntensity</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">updateMood</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Code notes</h4>\n<ul>\n<li>\n<p>We keep track of state in the <code class=\"language-text\">mood</code> variable. The facial expressions, RGB LED colors, and sounds are all derived from <code class=\"language-text\">mood</code> and mood is mostly derived from <code class=\"language-text\">esteem</code> (not shown here; it’s based on how often Grandbot is played with). The exceptions are two states: <code class=\"language-text\">uninitialized</code> and <code class=\"language-text\">sleeping</code>.</p>\n<ul>\n<li><code class=\"language-text\">uninitialized</code> (-1) is set when booting so I can have special behavior on initial loading.</li>\n<li>As you see here, <code class=\"language-text\">sleep</code> (0) is based on light input.</li>\n</ul>\n</li>\n<li>Grandbot wakes up if it’s been asleep and if light input is above the <code class=\"language-text\">wakeThreshold</code>. Waking up starts blinking behavior, turns up the brightness of the display, and updates <code class=\"language-text\">mood</code> (based on esteem). I didn’t show this, but it also updates <code class=\"language-text\">lastPlayTime</code> so it doesn’t wake up unhappy.</li>\n<li>Grandbot goes to sleep if it’s uninitialized or if it’s in a normal mood and the light reading is below the <code class=\"language-text\">sleepThreshold</code>. Sleep dims the 4D7S display and sets a sleep expression. I didn’t show this, but it also plays sleepy music if it’s going to sleep from a normal mood (not when it’s being initialized).</li>\n</ul>\n<p>Hopefully this gets the idea across, but the link to the current state of the code is above. It might clear things up, but it’ll probably just make any sane developer sad.</p>\n<h2>Conclusion</h2>\n<p>It’s really cute to see Grandbot go to sleep! As I’ll write about in other posts, it plays a little tune when going to bed: a random, arpeggiated, Major 7th chord.</p>","frontmatter":{"title":"Grandbot Update - Sleep","date":"May 15, 2020","description":"Putting Grandbot to sleep with a photoresistor."}}},"pageContext":{"slug":"/grandbot-update-sleep/","previous":{"fields":{"slug":"/max7219-emoji/"},"frontmatter":{"title":"Max7219 Emoji"}},"next":{"fields":{"slug":"/grandbot-update-voice/"},"frontmatter":{"title":"Grandbot Update - Voice"}}}},"staticQueryHashes":["2893060334","63159454"]}