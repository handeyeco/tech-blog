{"componentChunkName":"component---src-templates-blog-post-js","path":"/max7219-emoji/","result":{"data":{"site":{"siteMetadata":{"title":"Tech Blog"}},"markdownRemark":{"id":"8adea978-79ae-598b-b9af-31b466701dc9","excerpt":"Blinking expression on display Disclaimer: I don’t know what I’m talking about. I’m a JavaScript dev who’s just learning this stuff too. I’m sharing what I…","html":"<p><img src=\"/tech-blog/d8b6a3d50c3450c853be0c122beb3950/blinking.gif\" alt=\"Blinking expression on display\"></p>\n<p><em><strong>Disclaimer:</strong> I don’t know what I’m talking about. I’m a JavaScript dev who’s just learning this stuff too. I’m sharing what I <strong>think</strong> I learned, but that doesn’t make it the truth.</em></p>\n<p><em>Project originally inspired by the work of <a href=\"https://twitter.com/MohitBhoite\">Mohit Bhoite</a>.</em></p>\n<p>In my last <a href=\"https://handeyeco.github.io/tech-blog/seven-segment-emoji/\">post</a> on 4-digit, 7-segment displays, I realized I would need help multiplexing if I wanted to free up the Arduino to do more complex things (like using sensors and changing expressions). In the end I decided to use the Max7219 display driver and the LedControl Arduino library.</p>\n<p>The Max7219 is a chip specifically designed to control LED matrices. It replaces the shift register, transistor driver circuits, and limiting resistors I used in the last 4D7S build. It also handles multiplexing so the Arduino doesn’t have to. Arduino has a great <a href=\"https://playground.arduino.cc/Main/MAX72XXHardware/\">resource on using the Max7219</a>; I’d recommend starting there if you’re interested in using the Max7219.</p>\n<h2>The Build</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/2d5050061315212f5f38a230af4ea573/0c969/schematic.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAQL/xAAVAQEBAAAAAAAAAAAAAAAAAAABAP/aAAwDAQACEAMQAAABu4Rg0CAv/8QAGRAAAwADAAAAAAAAAAAAAAAAAAERAhAS/9oACAEBAAEFAux5UTLqn//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABkQAAMBAQEAAAAAAAAAAAAAAAABESExQf/aAAgBAQABPyFw4joMPR1tYnmik//aAAwDAQACAAMAAAAQ0C//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxAn/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAECAQE/EFtb/8QAGxABAAIDAQEAAAAAAAAAAAAAAQARITFRQXH/2gAIAQEAAT8QQNjVJNop8eQPW0sGQcicmUKMz//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Schematic of the build\"\n        title=\"Schematic of the build\"\n        src=\"/tech-blog/static/2d5050061315212f5f38a230af4ea573/1c72d/schematic.jpg\"\n        srcset=\"/tech-blog/static/2d5050061315212f5f38a230af4ea573/a80bd/schematic.jpg 148w,\n/tech-blog/static/2d5050061315212f5f38a230af4ea573/1c91a/schematic.jpg 295w,\n/tech-blog/static/2d5050061315212f5f38a230af4ea573/1c72d/schematic.jpg 590w,\n/tech-blog/static/2d5050061315212f5f38a230af4ea573/a8a14/schematic.jpg 885w,\n/tech-blog/static/2d5050061315212f5f38a230af4ea573/fbd2c/schematic.jpg 1180w,\n/tech-blog/static/2d5050061315212f5f38a230af4ea573/0c969/schematic.jpg 2411w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<figcaption>Schematic of the build</figcaption>\n<h3>Components</h3>\n<p>I believe you could use any common cathode display, but be sure to check the display’s datasheet for forward voltage and DC forward current. Use those two values in the chart in the Max7219 datasheet to get the appropriate value for R1.</p>\n<ul>\n<li>Arduino Uno R3</li>\n<li>TDCG1060M common cathode 4-digit, 7-segment (4D7S) display</li>\n<li>Max7219</li>\n<li>10uF electrolytic capacitor (C1)</li>\n<li>0.1uF ceramic capacitor (C2)</li>\n<li>22k ohm resistor (R1)</li>\n</ul>\n<h4>Component notes</h4>\n<ul>\n<li>\n<p>Max7219</p>\n<ul>\n<li>As mentioned above, it’s a chip that’s specifically designed to drive a bunch of LEDs (up to 64 per chip).</li>\n<li>I believe Dout (pin 24) is used to chain several Max7219s together. Wasn’t needed in this case.</li>\n<li>I only used the first four digit pins. With all eight, you’d be able to control two 4D7S displays.</li>\n<li>Both grounds need to be connected.</li>\n<li>Just like the 74HC595, we’re using serial communication with the Load (12), Clock (13), and Din (1) pins. Doesn’t matter which Arduino pins you connect them to as long as you update the code.</li>\n</ul>\n</li>\n<li>The capacitors are required by the Max7219 datasheet. They clean power-supply ripple…though I’m not 100% sure what that means.</li>\n<li>My understanding of the ISET resistor is that it limits the current going out to the LEDs. As mentioned above, the value depends on the 4D7S display being used.</li>\n</ul>\n<h3>Code</h3>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"LedControl.h\"</span></span>\n\n<span class=\"token comment\">// Arduino Pins</span>\n<span class=\"token keyword\">int</span> dataPin <span class=\"token operator\">=</span> <span class=\"token number\">12</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> clockPin <span class=\"token operator\">=</span> <span class=\"token number\">11</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> loadPin <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* \n * Initialize the LedControl object\n * it will set the pin directions for us\n * and provide us with controls for the Max7219\n */</span>\nLedControl lc <span class=\"token operator\">=</span> <span class=\"token function\">LedControl</span><span class=\"token punctuation\">(</span>dataPin<span class=\"token punctuation\">,</span> clockPin<span class=\"token punctuation\">,</span> loadPin<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Gives us a future timestamp</span>\n<span class=\"token comment\">// between 2 and 10 seconds in the future</span>\n<span class=\"token keyword\">int</span> <span class=\"token function\">getNextBlink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Random blink length between 100 and 300 ms</span>\n<span class=\"token keyword\">int</span> <span class=\"token function\">getBlinkLength</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">300</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// State</span>\n<span class=\"token keyword\">int</span> nextBlink <span class=\"token operator\">=</span> <span class=\"token function\">getNextBlink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> blinkLength <span class=\"token operator\">=</span> <span class=\"token function\">getBlinkLength</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">boolean</span> isBlinking <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Expressions:</span>\n<span class=\"token comment\">// 1 byte/digit describing segment data</span>\n<span class=\"token keyword\">int</span> forward<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  B00000000<span class=\"token punctuation\">,</span>\n  B11011101<span class=\"token punctuation\">,</span>\n  B01011101<span class=\"token punctuation\">,</span>\n  B00000000\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">int</span> blinking<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  B00000000<span class=\"token punctuation\">,</span>\n  B10001000<span class=\"token punctuation\">,</span>\n  B00001000<span class=\"token punctuation\">,</span>\n  B00000000\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">writeExpression</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> expr<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// For each digit in the display...</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...send that digit's segment data</span>\n    lc<span class=\"token punctuation\">.</span><span class=\"token function\">setRow</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">,</span> expr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token keyword\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*\n   The MAX72XX is in power-saving mode on startup,\n   we have to do a wakeup call\n   */</span>\n  lc<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">/* Set the brightness to high */</span>\n  lc<span class=\"token punctuation\">.</span><span class=\"token function\">setIntensity</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">/* Only scan the first 4 digits */</span>\n  lc<span class=\"token punctuation\">.</span><span class=\"token function\">setScanLimit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">/* Clear the display */</span>\n  lc<span class=\"token punctuation\">.</span><span class=\"token function\">clearDisplay</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token keyword\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> now <span class=\"token operator\">=</span> <span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">/* \n   * If not blinking, but should be\n   * start blink\n   */</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isBlinking <span class=\"token operator\">&amp;&amp;</span> now <span class=\"token operator\">></span> nextBlink<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    isBlinking <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">writeExpression</span><span class=\"token punctuation\">(</span>blinking<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token comment\">/*\n   * If blinking, but we passed the blink length\n   * end blink and set next blink times\n   */</span>\n  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isBlinking <span class=\"token operator\">&amp;&amp;</span> now <span class=\"token operator\">></span> nextBlink <span class=\"token operator\">+</span> blinkLength<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    isBlinking <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">writeExpression</span><span class=\"token punctuation\">(</span>forward<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    nextBlink <span class=\"token operator\">=</span> <span class=\"token function\">getNextBlink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    blinkLength <span class=\"token operator\">=</span> <span class=\"token function\">getBlinkLength</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Code notes</h4>\n<p>I used the <a href=\"https://github.com/wayoda/LedControl\">LedControl library</a>. I actually started writing my own code for the Max7219 since I wasn’t using a lot of the features in the LedControl lib, but eventually I realized I had rewritten almost every function provided by that lib. I learned a lot in the process but ultimately decided not to reinvent the wheel.</p>\n<p>Most of the code is initializing the Max7219 and creating helper functions for improved readability. The basic idea is simple:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">- Create a future timestamp to determine when to blink\n- Create a random blink length\n- When we pass the timestamp, start blinking\n- When we pass the timestamp + blink length, stop blinking\n- Repeat</code></pre></div>\n<p>We want to keep track of whether we’re blinking or not so we only send data to the Max7219 when we need to.</p>\n<p>The only other weird part is the expressions. In my last 4D7S post, I talked about using 8 bits (a byte) to represent the state of each LED in a digit (7 segments + the decimal point). Since we have four digits, we use four bytes per expression. So:</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token keyword\">int</span> forward<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  B00000000<span class=\"token punctuation\">,</span> <span class=\"token comment\">// blank</span>\n  B11011101<span class=\"token punctuation\">,</span> <span class=\"token comment\">// small circle w/ eyebrow (decimal point)</span>\n  B01011101<span class=\"token punctuation\">,</span> <span class=\"token comment\">// small circle w/ eyebrow (no decimal point)</span>\n  B00000000  <span class=\"token comment\">// blank </span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The difference from the last 4D7S post is that the Max7219 expects the decimal point first rather than last:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">B 0 0 0 0 0 0 0 0\n DP A B C D E F G</code></pre></div>\n<p>Then we just iterate over the expression, setting each digit to each byte in order. This is done in <code class=\"language-text\">writeExpression</code> using the LedControl <code class=\"language-text\">setRow</code> function (if you think of the LEDs as being in a matrix, each digit is a row).</p>\n<h2>Conclusion</h2>\n<p>This was a fun extension to the last project and freed up even more Arduino pins for other things. My next step is to extract some of the expression logic into a class, add more expressions, and add some sort of sensor to determine which expression should show. I also plan to add a buzzer so it can start making cute sounds.</p>\n<p>Unfortunately it wasn’t all good news. For awhile I thought I had a hardware issue (it was actually a software issue before I started using the LedControl lib) and while tracking down the source of the bug I burnt out my original 4D7S display. It’s sad to lose a friend, but it will always be remembered. RIP.</p>","frontmatter":{"title":"Max7219 Emoji","date":"May 04, 2020","description":"Experimenting with the Max7219 and a 4-digit, 7-segment display."}}},"pageContext":{"slug":"/max7219-emoji/","previous":{"fields":{"slug":"/audio-sensor/"},"frontmatter":{"title":"Arduino Audio Alarm"}},"next":{"fields":{"slug":"/grandbot-update-sleep/"},"frontmatter":{"title":"Grandbot: Sleep"}}}},"staticQueryHashes":["63159454"]}