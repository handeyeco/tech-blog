{"componentChunkName":"component---src-templates-blog-post-js","path":"/concurrent-arduino/","result":{"data":{"site":{"siteMetadata":{"title":"Tech Blog"}},"markdownRemark":{"id":"afeba7fd-506f-5d0b-b893-319b16f36e13","excerpt":"For a more fleshed out example, you can see how Grandbot uses this behavior as of this tag for his light and voice. In an effort to create smooth RGB LED…","html":"<p><em>For a more fleshed out example, you can see how Grandbot uses this behavior as of this <a href=\"https://github.com/handeyeco/Grandbot/tree/2020-05-27\">tag</a> for his <a href=\"https://github.com/handeyeco/Grandbot/blob/2020-05-27/src/Light.cpp\">light</a> and <a href=\"https://github.com/handeyeco/Grandbot/blob/2020-05-27/src/Voice.cpp\">voice</a>.</em></p>\n<p>In an effort to create smooth RGB LED transitions in Arduino in a way that didn’t completely block the main thread, I explored tweening using a repeatedly called update method in the class controlling my LED. Unfortunately part of my project, a buzzer playing a little melody, also blocked the main thread and broke my LED tweening. This was an existing bug that also blocked interaction with the project, so it was an opportunity to learn more about keeping the main thread free while improving the project.</p>\n<p>In this post I’ll talk about creating long-running yet non-blocking transitions for RGB LEDs and also cover a strategy for playing melodies with the Arduino <code class=\"language-text\">tone</code> function without blocking the main thread.</p>\n<h2>RGB LED transition</h2>\n<p>A naive first try at an LED transition might look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token keyword\">int</span> currR <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> currG <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> currB <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...write to LED...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">boolean</span> <span class=\"token function\">transitionComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    currR <span class=\"token operator\">==</span> nextR <span class=\"token operator\">&amp;&amp;</span>\n    currG <span class=\"token operator\">==</span> nextG <span class=\"token operator\">&amp;&amp;</span>\n    currB <span class=\"token operator\">==</span> nextB\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">sign</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Gets called once</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> nextR <span class=\"token operator\">=</span> <span class=\"token number\">255</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> nextG <span class=\"token operator\">=</span> <span class=\"token number\">255</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> nextB <span class=\"token operator\">=</span> <span class=\"token number\">255</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">transitionComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    currR <span class=\"token operator\">+=</span> <span class=\"token function\">sign</span><span class=\"token punctuation\">(</span>nextR <span class=\"token operator\">-</span> currR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    currG <span class=\"token operator\">+=</span> <span class=\"token function\">sign</span><span class=\"token punctuation\">(</span>nextG <span class=\"token operator\">-</span> currG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    currB <span class=\"token operator\">+=</span> <span class=\"token function\">sign</span><span class=\"token punctuation\">(</span>nextB <span class=\"token operator\">-</span> currB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>currR<span class=\"token punctuation\">,</span> currG<span class=\"token punctuation\">,</span> currB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This should transition the LED correctly between two states, but unfortunately the <code class=\"language-text\">while</code> loop blocks the main thread preventing the Arduino from doing anything other than transitioning the LED.</p>\n<p>The solution that worked for me was setting the next state in a separate method and creating a frequently called <code class=\"language-text\">update</code> method that tweens between two states. Tweening is a technique in animation that is used to transition between two states based off of an animation length and the current progress.</p>\n<p>There’s a lot more to keep track of and some <em>math</em>, but it’s an effective way to transition the LED.</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token keyword\">int</span> prevR <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> prevG <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> prevB <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> nextR <span class=\"token operator\">=</span> <span class=\"token number\">255</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> nextG <span class=\"token operator\">=</span> <span class=\"token number\">255</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> nextB <span class=\"token operator\">=</span> <span class=\"token number\">255</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Find the difference between the two states</span>\n<span class=\"token keyword\">int</span> deltaR <span class=\"token operator\">=</span> nextR <span class=\"token operator\">-</span> prevR<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> deltaG <span class=\"token operator\">=</span> nextG <span class=\"token operator\">-</span> prevG<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> deltaB <span class=\"token operator\">=</span> nextB <span class=\"token operator\">-</span> prevB<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Animation should last 2 seconds and start now</span>\n<span class=\"token keyword\">int</span> animationLength <span class=\"token operator\">=</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">;</span>\nunsigned <span class=\"token keyword\">long</span> animationStart <span class=\"token operator\">=</span> <span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...write to LED...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Gets called repeatedly in the main loop()</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Determine how long the animation has run</span>\n  unsigned <span class=\"token keyword\">long</span> now <span class=\"token operator\">=</span> <span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> elapsed <span class=\"token operator\">=</span> now <span class=\"token operator\">-</span> animationStart<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Determine progress through the animation</span>\n  <span class=\"token comment\">// capped at 1 (100%)</span>\n  float progress <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>float<span class=\"token punctuation\">)</span> elapsed <span class=\"token operator\">/</span> animationLength<span class=\"token punctuation\">;</span>\n  float capped <span class=\"token operator\">=</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Tween</span>\n  <span class=\"token keyword\">int</span> r <span class=\"token operator\">=</span> prevR <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>capped <span class=\"token operator\">*</span> deltaR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> g <span class=\"token operator\">=</span> prevG <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>capped <span class=\"token operator\">*</span> deltaG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> b <span class=\"token operator\">=</span> prevB <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>capped <span class=\"token operator\">*</span> deltaB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then we can create a swirling effect by adding a conditional to the <code class=\"language-text\">update</code> method.</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// Can be called repeatedly in the main loop()</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  unsigned <span class=\"token keyword\">long</span> now <span class=\"token operator\">=</span> <span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> elapsed <span class=\"token operator\">=</span> now <span class=\"token operator\">-</span> animationStart<span class=\"token punctuation\">;</span>\n  float progress <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>float<span class=\"token punctuation\">)</span> elapsed <span class=\"token operator\">/</span> animationLength<span class=\"token punctuation\">;</span>\n  float capped <span class=\"token operator\">=</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">int</span> r <span class=\"token operator\">=</span> prevR <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>capped <span class=\"token operator\">*</span> deltaR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> g <span class=\"token operator\">=</span> prevG <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>capped <span class=\"token operator\">*</span> deltaG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> b <span class=\"token operator\">=</span> prevB <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>capped <span class=\"token operator\">*</span> deltaB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">process</span> <span class=\"token operator\">>=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    prevR <span class=\"token operator\">=</span> nextR<span class=\"token punctuation\">;</span>\n    prevG <span class=\"token operator\">=</span> nextG<span class=\"token punctuation\">;</span>\n    prevB <span class=\"token operator\">=</span> nextB<span class=\"token punctuation\">;</span>\n    nextR <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    nextG <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    nextB <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    deltaR <span class=\"token operator\">=</span> nextR <span class=\"token operator\">-</span> prevR<span class=\"token punctuation\">;</span>\n    deltaG <span class=\"token operator\">=</span> nextG <span class=\"token operator\">-</span> prevG<span class=\"token punctuation\">;</span>\n    deltaB <span class=\"token operator\">=</span> nextB <span class=\"token operator\">-</span> prevB<span class=\"token punctuation\">;</span>\n    animationStart <span class=\"token operator\">=</span> now<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This frees up the thread, but created two new problems:</p>\n<ol>\n<li>I change the next color state with a user interaction (pressing a button) which creates a hard transition when starting a new animation during a currently running animation. It’s not a huge problem, so I haven’t dived into fixing this.</li>\n<li>If something <em>else</em> is blocking the main thread, two seconds can pass and the whole animation is skipped over. This was the case with my buzzer code as it played a little melody when a user interacted with the project. So I needed a way to play the melody in a non-blocking way!</li>\n</ol>\n<h2>Non-blocking melody</h2>\n<p>This was a little more tricky and the melody will have a slightly less precise rhythm. The upside however is that a user can continue to interact with the project while a melody is being played; a bonus feature for fixing the LED transition problem.</p>\n<p>Most examples for working with <code class=\"language-text\">tone</code> go something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token keyword\">int</span> tonePin <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Gets called on user interaction</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// play 2kHz for 2 seconds</span>\n  <span class=\"token function\">tone</span><span class=\"token punctuation\">(</span>tonePin<span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// play 4kHz for 1 second</span>\n  <span class=\"token function\">tone</span><span class=\"token punctuation\">(</span>tonePin<span class=\"token punctuation\">,</span> <span class=\"token number\">4000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">noTone</span><span class=\"token punctuation\">(</span>tonePin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>But of course this will block the thread for 3 seconds - a lifetime for a process to run.</p>\n<p>My alternative solution requires a lot of code and definitely needs some refinement, but has been working for my basic needs:</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token keyword\">int</span> tonePin <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// -1 means we haven't started the melody</span>\n<span class=\"token keyword\">int</span> currNoteIndex <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Timestamp when we started the last note</span>\nunsigned <span class=\"token keyword\">long</span> noteStart <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">boolean</span> playing <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">int</span> melodyLength <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Array of frequencies</span>\n<span class=\"token keyword\">int</span> melody<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4000</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Array of times (beats)</span>\n<span class=\"token keyword\">int</span> rhythm<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Gets called on user interaction</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  playing <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  currNoteIndex <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Gets called repeatedly in the main loop()</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>playing<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\n  unsigned <span class=\"token keyword\">long</span> now <span class=\"token operator\">=</span> <span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token comment\">// If we're just starting the melody...</span>\n    currNoteIndex <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span>\n    <span class=\"token comment\">// ... or we've been playing the current note too long...</span>\n    <span class=\"token operator\">||</span> now <span class=\"token operator\">></span> noteStart <span class=\"token operator\">+</span> rhythm<span class=\"token punctuation\">[</span>currNoteIndex<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...bump the note index.</span>\n    currNoteIndex<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// If the next note exists, play it...</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currNoteIndex <span class=\"token operator\">&lt;</span> melodyLength<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">tone</span><span class=\"token punctuation\">(</span>tonePin<span class=\"token punctuation\">,</span> melody<span class=\"token punctuation\">[</span>currNoteIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      noteStart <span class=\"token operator\">=</span> now<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// ...otherwise stop playing.</span>\n    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">noTone</span><span class=\"token punctuation\">(</span>tonePin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      playing <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So the secret here is that <code class=\"language-text\">tone</code> doesn’t need the thread to run, people just tend to block the thread to keep track of how long we’ve been playing the tone. If we don’t care too much about precision we can start the tone, do other things, and check in regularly to see if we need to stop or change the tone.</p>\n<p>Obviously the code is chaotic and the way I’m managing the arrangement of notes/beats isn’t ideal, but this could all probably be cleaned up. For my own project I made the note/beat arrays pretty big and just rewrote the values when the melody needed to change.</p>\n<p>Unfortunately this created its own issue: since the button-press played a melody and the melody was blocking, the melody acted as a sort of debounce for the button. Now that the melody is non-blocking, the button-press is a little more jittery.</p>\n<h2>Conclusion</h2>\n<p>So the basic idea is pretty straight-forward, we have a master loop and several “services” (as feature-specific classes) that each have their own loops that run and release the thread as quickly as possible. With this paradigm we can start “multitasking” on a single thread!</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token keyword\">void</span> <span class=\"token keyword\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  light<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  sound<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// ...other things...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"Concurrent Arduino","date":"May 27, 2020","description":"Long-running, non-blocking behavior in Arduino's single thread."}}},"pageContext":{"slug":"/concurrent-arduino/","previous":{"fields":{"slug":"/nts-nano-clone/"},"frontmatter":{"title":"Note to Self - Nano Clone on High Sierra"}},"next":{"fields":{"slug":"/databend/"},"frontmatter":{"title":"Databending with Web APIs"}}}},"staticQueryHashes":["2893060334","63159454"]}