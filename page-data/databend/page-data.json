{"componentChunkName":"component---src-templates-blog-post-js","path":"/databend/","result":{"data":{"site":{"siteMetadata":{"title":"Tech Blog"}},"markdownRemark":{"id":"2fc51ee7-94cd-5d72-8576-4e55aba2c651","excerpt":"An example of an image that was databent using my web-based databending application. Databending with Web APIs This repo hosts this blog post and a simplified…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/d2c7ee658c299cd6400a5235cded5c34/00d43/graffiti_application.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.89189189189189%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAADUUlEQVQ4yw2T2VsadxSG57/uVW7adLFZatsYlxiNEJHFhR1lEXEcUPZhHWCiQFiEimA0IkZ/b+fi3J3nO8/7fd+RvkWSTE0dLrbiuF+qbK57hX3zAO+nKAfvg2TXitTnq0zmVHLuCNZQjNNKjJm5jPIijzwfIjEvs/GiiPZvEam5UhatRV3oS30RMDeExd8l5/sq7o66dFa/UHx3xnCpTmVP496boBH0cesPglWm8zpB2l5BbdQJeydUPOdI67YZumVM/n0Ph6NLNNdFKbToatDY/k7lL43xmxIFuUQzMaB4lGKwW2C6ecydNUJpv0Ql02W/MMbvuUOy+3+Q/jAm/rHGvqvHdqKNy5iL1j3tPePQusLDskrPfcbIesLQkaR1PKZtyTNYzqKYW8SLI5TchLzlBqmw00Ox5TjyjNkJDNhNdJGLQ8baA8WdMdXFGHeWDHWbjxtbhCt/iv4/V/RX0uQWYljnyhTrHSKpAcfbfaTLw3MUR58dxyP+Uo8DVxslfMn18ZSxa0DzbZraap07X5DnqMfAVGi/KnFtSZLeOMb3h+FjosS51qTqryDVTmv4vZd4whqaXsO7qpNZHjItPDILjygvqvg+Zfjq9HITDfNgaRhB5bnailIwxKMvL8jEe1QqBZKBFJKsqLiOavRO3VzFFC7XmkxXylwGm2R2+7gtZeS1OMIX4MkZFsSyPCvnPGxc01moEvnFsMiZQ1WT7GWzSJ9/LmNTNDqhCH1HiG8LOTAqkjzIY7LpOFfPSCxHGZvjYhJO079q0T8bI/99RX2uzsWvRfK5Y1JyjkhERdJfp9BMeW5WQoxMHmZ7GQjopOw1gpsZlECU6t4tUdME19yjWEo8iWx6gma+pvpxKJ42VNFvJUnEk0IL7iOpiy2KnjRP3m2+B7eY+mp8d2lY1y8wLVcJnsSIeCfCeXBH6PBRbDTuRazyg9G7B5F4O+TEWSNUSYm0nCYeSiM5PIK4v8fNfpunnQGYeox8VQ5/V5H3C5zounAocKQ/iy88Cx8Cdxohr8zw/lQTgdBARErG2yb/E1EDTpI/G4SJe/TwDGzA/IShq4j9wznujRz23xr8uQme8Y2oTm+F01gxui0svhnmVwfija2CPZgSVvlRRP3wP1w7Z27ZDknoAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Image that has been databent with my custom databend application\"\n        title=\"Image that has been databent with my custom databend application\"\n        src=\"/tech-blog/static/d2c7ee658c299cd6400a5235cded5c34/fcda8/graffiti_application.png\"\n        srcset=\"/tech-blog/static/d2c7ee658c299cd6400a5235cded5c34/12f09/graffiti_application.png 148w,\n/tech-blog/static/d2c7ee658c299cd6400a5235cded5c34/e4a3f/graffiti_application.png 295w,\n/tech-blog/static/d2c7ee658c299cd6400a5235cded5c34/fcda8/graffiti_application.png 590w,\n/tech-blog/static/d2c7ee658c299cd6400a5235cded5c34/efc66/graffiti_application.png 885w,\n/tech-blog/static/d2c7ee658c299cd6400a5235cded5c34/00d43/graffiti_application.png 1000w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>An example of an image that was databent using my <a href=\"https://handeyeco.github.io/databend/\">web-based databending application</a>.</p>\n<h1>Databending with Web APIs</h1>\n<p>This repo hosts this blog post and a simplified example:</p>\n<ul>\n<li><a href=\"https://github.com/handeyeco/databend-blog\">Source</a></li>\n<li><a href=\"https://handeyeco.github.io/databend-blog/\">Demo</a></li>\n</ul>\n<p>It’s based on the work for a web application that builds a UI around this concept:</p>\n<ul>\n<li><a href=\"https://github.com/handeyeco/databend\">Source</a></li>\n<li><a href=\"https://handeyeco.github.io/databend/\">Application</a></li>\n</ul>\n<h2>Intro</h2>\n<p><a href=\"https://en.wikipedia.org/wiki/Databending\">Databending</a>, like circuit bending, is a way of creatively breaking technology to generate unique and unexpected results. In circuit bending, the idea is to mess around with the underlying electronics: modding, jumping, and shorting to find interesting ways to break circuits. In databending the idea is to break things in the data layer.</p>\n<p>Computers operate in 1s and 0s. We might see an “a” in a text file, but a computer will see “01100001”. The fact that we’re just dealing with numbers is important to databending: when we run an audio file through an EQ or an image through a filter, we might think the application has some sense for what a song or a picture is, but ultimately it’s just doing math. So what happens when we run an image through an EQ? Or an audio file through an image filter? That’s one sure-fire way to break things!</p>\n<p>A common example of databending (and how I learned about it) is to take the free audio software <a href=\"https://www.audacityteam.org/\">Audacity</a>, use its “raw data” import option to load in an image, run some audio effects over the image, and export the bits back out as an image file. Here’s an example of an image bent with Audacity:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/1cbd3e47a52f647f28fe577c3e9b587a/00d43/graffiti_audacity.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.89189189189189%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAADiklEQVQ4yw2T61cSdgCGf16WJ++Wl9Q0Y5WXaZk67w5S8YJTCAS8EV4QTVRQ8IIEgogiiiKlaZrztK221Xa2T/uws3P2nz3jD3jfD8/7vEJZ20dRu5nspX3aVpwseXeoWzsi3ePDf3DCxdklu+ELLq++8FAXRFY2Q1XfOp1SI5/CByxaN3lunUS75WBwZweh06qo2ryiPXBO6t4+xVIT4vgKcfIRX/Qzhug1epuJ+YiLhslGpHodveMmWvVt+Gw9HG7NUvfgPol5KdQ57iEsi120bodRec4psU3zqOwBHcdRSg78VHiCTAfWGXG5sYXK8fpbGAwXIGlPIaL/jn9Cdv4LT6KWt5F/O4fi+QyEemKGDFuUbOs+qdP7pDUoCPjlXHzaodoTYc4pZ8Tdjd77NcZVOcOHJchNBcz3VHLsbGbPKmWopYLyOxKK1jIRje1zpK2+pmrMTvpQiGy9meCZi6nT15gmfFh8MbaDOpwRJ4EffNTOt/PG2MBh8FtOPWm89ar4XlpNQV4GObZUxLTSxjOVD+HfJKHdT/Ksn4bIrxRZ3JgHZ1mw7tK9sUvn3g6Vb07oG+0kOpLP4kwJ68ZSPmzWojM8Ii0thSxNSoxhywKdlWEy1pZIbxqg2XKE++BHbhk20TWpmTo6pufsHbLTa4bXrlnt0PKLWUaPS8OofoXoXhuNigYSs3LJVMcjlp92UVO/hah2ED+zjHj/B8nvh7m5IOGboR7UMW36t5cZ7zjFOrOB16Blu3ScLPcWZc5r8iNvuTHopLRaSZPJiBgN6HFp7FQ81vAwtEz9koK2dQlDbj11lmaK1/3c+zmC8sU+Nt0BJ1IDvhI9Of4ABSsfKXB9Rgy40T0fZuPyAtFveUVA+owvk4WcjpXx9/QTpgayuKutoXYim1sKLUmeWPhohcemKxoWTtnLNVCweM0dx5/kGQ4R+c1MOYIsbh8jFKoXeJ9I+H2winfKen6bl2KtTyBzopCOBTnzsgl6x/zUmB0Y6i3YO4y8uqsh035J0sJPJCuNJBU2Yz38l1D0L8ScSYm3Jh6nIg6HKpFzjcD5VNDqSULTO85wSiHqRjOr/TIUQmAX8fQX5yJW8kiYiHmnKyazXM7LLh2jLfLYKB+6CDUnEjYWMjcmiakgCCrjaTMnotWtsN3jQ70URF96G2WssDshDpkkgRvym8RNCsTYV+Q3GliM/f+ldYb/ASGCDlxvy0zzAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Image that has been databent with Audacity\"\n        title=\"Image that has been databent with Audacity\"\n        src=\"/tech-blog/static/1cbd3e47a52f647f28fe577c3e9b587a/fcda8/graffiti_audacity.png\"\n        srcset=\"/tech-blog/static/1cbd3e47a52f647f28fe577c3e9b587a/12f09/graffiti_audacity.png 148w,\n/tech-blog/static/1cbd3e47a52f647f28fe577c3e9b587a/e4a3f/graffiti_audacity.png 295w,\n/tech-blog/static/1cbd3e47a52f647f28fe577c3e9b587a/fcda8/graffiti_audacity.png 590w,\n/tech-blog/static/1cbd3e47a52f647f28fe577c3e9b587a/efc66/graffiti_audacity.png 885w,\n/tech-blog/static/1cbd3e47a52f647f28fe577c3e9b587a/00d43/graffiti_audacity.png 1000w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>(<a href=\"https://unsplash.com/photos/green-and-yellow-abstract-painting-WKQt_X-SKFI\">Original image source</a>; <a href=\"https://www.youtube.com/watch?v=cXjwJPz4qi0\">Audacity databending tutorial</a>)</p>\n<p>It’s fairly easy to do, but it’s also fairly easy to do irreparable damage to the image file. That’s because in most files there’s a section of the bits devoted to the data and there’s a section of the bits devoted to metadata (the header). Running the header through the databending process can result in a file that can’t be opened because at a certain point applications can’t understand enough of the metadata to open the file.</p>\n<p>It’s also a long-ish iteration cycle. Audacity isn’t showing a preview of the image you’re destroying because it doesn’t know it’s working with an image; Audacity is just doing math with a bunch of bits you handed it.</p>\n<h2>The thing I made</h2>\n<p>As a kid I enjoyed breaking photos with Audacity to make pseudo-generative art and then I became a web developer. So after rediscovering databending, I decided to make my own application to speed up the process. In modern browsers we have a few tools that are relevant to this project:</p>\n<ol>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API\">Canvas API</a>: an API for working with images</li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API\">Web Audio API</a>: an API for working with audio</li>\n<li><a href=\"https://tonejs.github.io/\">Tone.js</a>: a library that takes the very low-level building blocks from the Web Audio API and abstracts them into higher-level audio tools (like BitCrusher and PitchShift).</li>\n</ol>\n<p>With these tools, I made the <a href=\"https://github.com/handeyeco/databend\">databend</a> project. It uses the Canvas API to convert an image into a bunch of numbers, runs the numbers through different audio effects provided by Tone.js, and then converts the resulting audio data back into an image.</p>\n<p>It doesn’t muck with the headers because it’s just manipulating the actual image/audio data. It knows its job is to destroy images, so it provides some previews of how the image will look on the other side of the process.</p>\n<h2>How it works</h2>\n<p>The code here will be based on the demo in <code class=\"language-text\">index.html</code> (<a href=\"https://handeyeco.github.io/databend-blog/\">shown here</a>). To see the full application code, check out its <a href=\"https://github.com/handeyeco/databend\">Github repo</a>.</p>\n<h3>From image to audio</h3>\n<p>The first step is getting image data. We do this by creating a Canvas context, rendering an image with it, and then pulling out the image data.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// pretend you have an image object</span>\n<span class=\"token comment\">// like by using `new Image()`</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> width<span class=\"token punctuation\">,</span> height <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> image\n\n<span class=\"token comment\">// Create a canvas twice the height of the image</span>\n<span class=\"token comment\">// so we can show before/after</span>\n<span class=\"token keyword\">const</span> imageMount <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'image-mount'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> canvas <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'canvas'</span><span class=\"token punctuation\">)</span>\ncanvas<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> width\ncanvas<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> height <span class=\"token operator\">*</span> <span class=\"token number\">2</span>\nimageMount<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>canvas<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Draw the original image</span>\n<span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2d'</span><span class=\"token punctuation\">)</span>\ncontext<span class=\"token punctuation\">.</span><span class=\"token function\">drawImage</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Get the image data</span>\n<span class=\"token comment\">// this is confusing: getImageData returns an object</span>\n<span class=\"token comment\">// containing a property called data</span>\n<span class=\"token keyword\">const</span> imageDataContainer <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getImageData</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> imageData <span class=\"token operator\">=</span> imageDataContainer<span class=\"token punctuation\">.</span>data</code></pre></div>\n<p>(<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/getContext\">getContext</a>, <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage\">drawImage</a>, <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/getImageData\">getImageData</a>)</p>\n<p>So what do you have at this point? You’re now the proud owner of a <code class=\"language-text\">Uint8ClampedArray</code> representing the image. It’s a 1D array that describes each pixel with four values: red, green, blue, and alpha (transparency). Each value is represented as a number between 0 and 255. So one pixel of fully opaque <a href=\"https://www.color-hex.com/color/4682b4\">steelblue</a> and one pixel of fully transparent <a href=\"https://www.color-hex.com/color/fa8072\">salmon</a> would be:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// R, G, B, A, R, G, B, A</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">70</span><span class=\"token punctuation\">,</span> <span class=\"token number\">130</span><span class=\"token punctuation\">,</span> <span class=\"token number\">180</span><span class=\"token punctuation\">,</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span> <span class=\"token number\">250</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">114</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>Audio works with floats between -1 and 1, so we need to do a conversion:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">scale</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">number<span class=\"token punctuation\">,</span> inMin<span class=\"token punctuation\">,</span> inMax<span class=\"token punctuation\">,</span> outMin<span class=\"token punctuation\">,</span> outMax</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>number <span class=\"token operator\">-</span> inMin<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>outMax <span class=\"token operator\">-</span> outMin<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>inMax <span class=\"token operator\">-</span> inMin<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> outMin<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Convert image (0 to 255) to audio (-1 to 1)</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">convertImageDataToAudioData</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">imageData</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> audioData <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Float32Array</span><span class=\"token punctuation\">(</span>imageData<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> imageData<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        audioData<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">scale</span><span class=\"token punctuation\">(</span>imageData<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> audioData\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Through Tone.js</h3>\n<p><em>I didn’t say this earlier, but thank you to the maintainers of and contributors to Tone.js. It’s just a gem of a library.</em></p>\n<p>At this point we have a Float32Array that looks enough like audio that we can pass it to Tone.js. In the application code, things gets a little convoluted here. I wrap each Tone.js module in a wrapper that allows me to apply a dry/wet mix.</p>\n<p>I also add an option to split the color channels before running the data through Tone.js: remember that the array is sorted as [R, G, B, A], this option creates four arrays ([R], [G], [B], [A]), runs them individually through the audio effects, and then merges them again on the other side. It’s hard to explain this, but think about a delay: a delay takes information from one position in the array and applies it to another position. By processing all the colors together, information from the red color might affect the blue color or alpha values. By splitting them, red will only affect red. Also it gives me the ability to only apply the effect to one color at a time.</p>\n<p><em>Anyway</em> here’s what it looks like in the demo when we run the data through Tone.js (without all of that added complexity):</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">processAudioData</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">audioData</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> audioContext <span class=\"token operator\">=</span> Tone<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// Create offline renderer so we don't have to wait for the \"audio\" to \"play\"</span>\n    <span class=\"token comment\">// before we get a buffer back that we can either manipulate more</span>\n    <span class=\"token comment\">// or convert to an image</span>\n    <span class=\"token keyword\">const</span> rendered <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Tone<span class=\"token punctuation\">.</span><span class=\"token function\">Offline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Create a one channel Web audio buffer to load audio data into</span>\n        <span class=\"token keyword\">const</span> buffer <span class=\"token operator\">=</span> audioContext<span class=\"token punctuation\">.</span><span class=\"token function\">createBuffer</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> audioData<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> audioContext<span class=\"token punctuation\">.</span>sampleRate<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> buffering <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">getChannelData</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// Fill the buffer with our data</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> audioData<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            buffering<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> audioData<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n\n\n        <span class=\"token comment\">// Create the Tone buffer module to play the audio data</span>\n        <span class=\"token keyword\">const</span> bufferNode <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Tone<span class=\"token punctuation\">.</span>ToneBufferSource</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// Create some effects that will process the audio data</span>\n        <span class=\"token keyword\">const</span> phaser <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Tone<span class=\"token punctuation\">.</span>Phaser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            frequency<span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> chebyshev <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Tone<span class=\"token punctuation\">.</span>Chebyshev</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            order<span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// Connect all the pieces together,</span>\n        <span class=\"token comment\">// including sending the data to the destination (output)</span>\n        bufferNode<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>phaser<span class=\"token punctuation\">)</span>\n        phaser<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>chebyshev<span class=\"token punctuation\">)</span>\n        chebyshev<span class=\"token punctuation\">.</span><span class=\"token function\">toDestination</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// Start the buffer playing</span>\n        bufferNode<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> audioData<span class=\"token punctuation\">.</span>length <span class=\"token operator\">/</span> audioContext<span class=\"token punctuation\">.</span>sampleRate<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> audioContext<span class=\"token punctuation\">.</span>sampleRate<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// Pull the raw data out of the updated buffer</span>\n    <span class=\"token keyword\">const</span> processedAudioData <span class=\"token operator\">=</span> rendered<span class=\"token punctuation\">.</span><span class=\"token function\">getChannelData</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> processedAudioData\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>(<a href=\"https://tonejs.github.io/docs/14.7.77/fn/getContext\">Tone.getContext</a>, <a href=\"https://tonejs.github.io/docs/14.7.77/fn/Offline\">Tone.Offline</a>, <a href=\"https://tonejs.github.io/docs/14.7.77/ToneBufferSource\">Tone.ToneBufferSource</a>, <a href=\"https://tonejs.github.io/docs/14.7.77/Phaser\">Tone.Phaser</a>, <a href=\"https://tonejs.github.io/docs/14.7.77/Chebyshev\">Tone.Chebyshev</a>, <a href=\"https://tonejs.github.io/docs/14.7.77/Destination\">Tone.toDestination</a>, <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/BaseAudioContext/createBuffer\">createBuffer</a>, <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/AudioBuffer/getChannelData\">getChannelData</a>, <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/AudioNode/connect\">connect</a>)</p>\n<p>Steps:</p>\n<ul>\n<li>Since we don’t actually want to listen to the audio, we create an offline Tone instance. Besides saving us from harsh noise, it also speeds up the process since it can run as fast as possible to render audio (rather than have to play the audio at a normal speed).</li>\n<li>We create a <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/AudioBuffer\">Web Audio API buffer</a> and populate it with the data we generated in the image-to-audio step.</li>\n<li>We create a Tone.js ToneBufferSource (using the Web Audio buffer) and some effects, connect them, and start the buffer playing.</li>\n<li>Tone.Offline returns a promise containing the buffer which contains the data we’ll convert back into an image.</li>\n<li>Once it’s all processed, we pull out the raw data from the buffer: another Float32Array.</li>\n</ul>\n<p>This is where the bulk of the experimentation happens. Here you can tweak the settings for the effects or replace them with any number of other Tone.js modules. For each new module, just make an instance using the constructor and add connections using <code class=\"language-text\">.connect</code>. Dig through the original application code to see how I added dry/wet mixes (although some effects have this built in) and the option to process individual colors.</p>\n<h3>From audio to image</h3>\n<p>From here we’ll scale the audio data (from -1 to 1) back to image data (from 0 to 255) and drop the updated pixels back into the Canvas context:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Convert audio (-1 to 1) to image (0 to 255)</span>\n<span class=\"token comment\">// (mutates the original imageData array with the new data)</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">convertAudioDataToImageData</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">imageData<span class=\"token punctuation\">,</span> audioData</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> audioData<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        imageData<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">scale</span><span class=\"token punctuation\">(</span>audioData<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">255</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Draw the modified image data</span>\n<span class=\"token comment\">// (offset by the height of the image,</span>\n<span class=\"token comment\">// so it doesn't overlap the \"before\" image)</span>\ncontext<span class=\"token punctuation\">.</span><span class=\"token function\">putImageData</span><span class=\"token punctuation\">(</span>imageDataContainer<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">)</span></code></pre></div>\n<p>(<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/putImageData\">putImageData</a>)</p>\n<p>Here’s the same image from the Audacity experiment, databent by playing around with the demo code in this repo:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/4890c354eb5f723d06e99504289310de/00d43/graffiti_databend.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.89189189189189%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACkUlEQVQ4yyWTSVPbUBCE/f8P+QE5pHJPKlW5hVQoKJchLEECY4wxXvFuybtsY2x15xMcpp40munp6dfKKXqxtyO52ZdbV3b7RM7n7Zjc61Q+LOQh8eWvfFO17+7lRlkO2vYR+R794wf5z538M3DOKooOqxNbw47UubUK91I/kcZzaUY0F1JhZJXX0uSN+p012EmNjZQOeV9KW/Jxopy2PVsjKeoTfJgO5XBh3SbyyZJPK4YA2qVhvLciyg+yVoC3Y2k/AJQzXZM3gMsG6Bt72LJaLzR2JTbzAvAChX0KB4A9Ef+IsqlPGZxQD/N9JssUQIbuzcq7Dt2x/FSxgiaAkVxcWTOAx2OrWpeup1aeOGaTOqvOYAqeYlim5MQW6atg6JzWgKwAvebs3KFLj1V4H6LrnOKLF+uUhgA2YWT1aNwCtge0y3N3Lpu1UYEsgMkFgA2rTnLyKN93rLAl9dB0xkWdAHiO8MW2VHqGFVIopRspHgEMlgBNgELbNNPQNV5Ce9fACjwHFbk8/NCsxF7nW2lUtEd5aX1DbR05cMAdwN8AOgPQiKc5Q7oAJhNry/QElu3Su/8UoU2fNasH6RTt4oI8O7M3lx/rPaPj50j6HVoXffphunvmrAA4rTKZAbM9ohLZtA0Nb2t5gz8GmHePkWcMfCtlHpRHkDjHs1cBhNnmALsElyy6aBg9WntsMMSsLc4yYFG2GezaxBg/KmQAf0LaRymGhtjpE3/IUWDVpnaKNDFD4hjAB25pgJoQFRct5Hr34RMnttSGu8s+upndYyY98jD0kmHfUzuAyIYfYD0AMMKHIeK2qb2h6BdxTAsWdGYvCCnEPssHgA6ZK5T5A1XkCk9fSf+AzIg/q1ezz2r+D1ou3MNtF6qRAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Image that has been databent with Audacity\"\n        title=\"Image that has been databent with Audacity\"\n        src=\"/tech-blog/static/4890c354eb5f723d06e99504289310de/fcda8/graffiti_databend.png\"\n        srcset=\"/tech-blog/static/4890c354eb5f723d06e99504289310de/12f09/graffiti_databend.png 148w,\n/tech-blog/static/4890c354eb5f723d06e99504289310de/e4a3f/graffiti_databend.png 295w,\n/tech-blog/static/4890c354eb5f723d06e99504289310de/fcda8/graffiti_databend.png 590w,\n/tech-blog/static/4890c354eb5f723d06e99504289310de/efc66/graffiti_databend.png 885w,\n/tech-blog/static/4890c354eb5f723d06e99504289310de/00d43/graffiti_databend.png 1000w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Conclusion</h2>\n<p>This isn’t the most performant way to do this. It’s laggy and front-end JavaScript is probably the last place we want to be processing large numbers of bits. I’m sure WASM or Web Workers or C++ would be a better alternative. I am glad I made this though; it highlights how far web APIs have come and how many tools we have available to us on the front-end. Plus I used this to make art that landed me on the cover of a zine I admire!</p>\n<p>Anyway, hope this helps someone. Happy hacking!</p>","frontmatter":{"title":"Databending with Web APIs","date":"February 24, 2024","description":"Using the Canvas and Web Audio APIs to databend images in the browser."}}},"pageContext":{"slug":"/databend/","previous":{"fields":{"slug":"/concurrent-arduino/"},"frontmatter":{"title":"Concurrent Arduino"}},"next":null}}}