{"componentChunkName":"component---src-templates-blog-post-js","path":"/grandbot-update-play/","result":{"data":{"site":{"siteMetadata":{"title":"Tech Blog"}},"markdownRemark":{"id":"1c48960f-72df-567a-a054-2420142a175a","excerpt":"Disclaimer: I don’t know what I’m talking about. I’m a JavaScript dev who’s just learning this stuff too. I’m sharing what I think I learned, but that doesn’t…","html":"<p><em><strong>Disclaimer:</strong> I don’t know what I’m talking about. I’m a JavaScript dev who’s just learning this stuff too. I’m sharing what I <strong>think</strong> I learned, but that doesn’t make it the truth.</em></p>\n<p><em>Project originally inspired by the work of <a href=\"https://twitter.com/MohitBhoite\">Mohit Bhoite</a>.</em></p>\n<p><em>Code references the state as of <a href=\"https://github.com/handeyeco/Grandbot/tree/2020-05-15\">this tag</a>.</em></p>\n<p>The past week has been a big one for the newly named Grandbot project. I finally got to a place where I felt it was time to take a deep dive into C++ and implemented a bunch of new features while learning more about electronics and Arduino programming. Even though the hardware side of things is fairly straightforward, I’m breaking this post into several parts since the code is exponentially more complex now.</p>\n<p>As I mentioned in the last two posts, Grandbot now has “moods” that affect his sounds, expressions, and lights. So how is a mood set? By playing with him of course! Right now the only way to interact with him is with a push button, but hopefully in the future he’ll be more interactive.</p>\n<h2>Adding a button</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/3dd729ae92ad38af6b9fbd4ae2b2a157/6951b/schematic.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwX/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAdet1zYED//EABgQAAIDAAAAAAAAAAAAAAAAAAABEDFB/9oACAEBAAEFAh3Gn//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABcQAAMBAAAAAAAAAAAAAAAAAAARIDH/2gAIAQEABj8C0U//xAAbEAEAAgIDAAAAAAAAAAAAAAABABEQITFBYf/aAAgBAQABPyGm+cSVLs8hdbZ3l//aAAwDAQACAAMAAAAQCO//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAcEAEAAgIDAQAAAAAAAAAAAAABABExQSFRcZH/2gAIAQEAAT8QovYOqOIWSsTbJ3Hkb6Q4+RwjlNvs/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Schematic of the build\"\n        title=\"Schematic of the build\"\n        src=\"/tech-blog/static/3dd729ae92ad38af6b9fbd4ae2b2a157/1c72d/schematic.jpg\"\n        srcset=\"/tech-blog/static/3dd729ae92ad38af6b9fbd4ae2b2a157/a80bd/schematic.jpg 148w,\n/tech-blog/static/3dd729ae92ad38af6b9fbd4ae2b2a157/1c91a/schematic.jpg 295w,\n/tech-blog/static/3dd729ae92ad38af6b9fbd4ae2b2a157/1c72d/schematic.jpg 590w,\n/tech-blog/static/3dd729ae92ad38af6b9fbd4ae2b2a157/a8a14/schematic.jpg 885w,\n/tech-blog/static/3dd729ae92ad38af6b9fbd4ae2b2a157/fbd2c/schematic.jpg 1180w,\n/tech-blog/static/3dd729ae92ad38af6b9fbd4ae2b2a157/6951b/schematic.jpg 1950w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<figcaption>Schematic of the build</figcaption>\n<h3>Components</h3>\n<ul>\n<li>Push button</li>\n<li>10k Ohm resistor</li>\n<li>Arduino Uno</li>\n</ul>\n<h4>Component notes</h4>\n<p>There’s not much to this one. As far as I understand it, the resistor is a pull-down resistor to prevent the pin from floating when the button is not pressed.</p>\n<h3>Code</h3>\n<p>The code is pretty rough right now, but hopefully the idea is there. I’m not going to show everything, just the button-related stuff.</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// main.cpp</span>\n\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> playPin 2</span>\n\n<span class=\"token comment\">// ...set other pins...</span>\n\nGrandbot gb <span class=\"token operator\">=</span> <span class=\"token function\">Grandbot</span><span class=\"token punctuation\">(</span>dataPin<span class=\"token punctuation\">,</span> clockPin<span class=\"token punctuation\">,</span> loadPin<span class=\"token punctuation\">,</span> voicePin<span class=\"token punctuation\">,</span> redPin<span class=\"token punctuation\">,</span> greenPin<span class=\"token punctuation\">,</span> bluePin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Used to track the transition</span>\n<span class=\"token comment\">// between on and off</span>\n<span class=\"token keyword\">int</span> lastPlayState <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token keyword\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">pinMode</span><span class=\"token punctuation\">(</span>playPin<span class=\"token punctuation\">,</span> <span class=\"token constant\">INPUT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token keyword\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Get current state of button</span>\n  <span class=\"token keyword\">int</span> playing <span class=\"token operator\">=</span> <span class=\"token function\">digitalRead</span><span class=\"token punctuation\">(</span>playPin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Do different things if button state changed</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>playing <span class=\"token operator\">&amp;&amp;</span> lastPlayState <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    gb<span class=\"token punctuation\">.</span><span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    lastPlayState <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>lastPlayState<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>playing <span class=\"token operator\">&amp;&amp;</span> lastPlayState <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    lastPlayState <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>lastPlayState<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As I mentioned a previous post, Grandbot’s <code class=\"language-text\">esteem</code> is based on how often he’s played with, his <code class=\"language-text\">mood</code> is based off his <code class=\"language-text\">esteem</code>, and everything else is based on his <code class=\"language-text\">mood</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// Grandbot.cpp</span>\n\nclass <span class=\"token class-name\">Grandbot</span> <span class=\"token punctuation\">{</span>\n    private<span class=\"token operator\">:</span>\n        <span class=\"token comment\">// -1 = uninitialized</span>\n        <span class=\"token comment\">//  0 = sleeping</span>\n        <span class=\"token comment\">//  1 = happy</span>\n        <span class=\"token comment\">//  2 = neutral</span>\n        <span class=\"token comment\">//  3 = unhappy</span>\n        <span class=\"token keyword\">int</span> mood <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// between 0 (unhappiest) and 9 (happiest)</span>\n        <span class=\"token keyword\">int</span> esteem <span class=\"token operator\">=</span> <span class=\"token number\">7</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">void</span> <span class=\"token function\">updateEsteem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">void</span> <span class=\"token function\">updateMood</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        unsigned <span class=\"token keyword\">long</span> lastPlayTime <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    public<span class=\"token operator\">:</span>\n        <span class=\"token keyword\">void</span> <span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">void</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> light<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We want to encourage regular interactions throughout the day, rather than just playing a bunch all at once. So we only bump <code class=\"language-text\">esteem</code> once for every hour of play (3,600,00ms).</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// Grandbot.cpp</span>\n\n<span class=\"token keyword\">void</span> Grandbot<span class=\"token operator\">::</span><span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  unsigned <span class=\"token keyword\">long</span> now <span class=\"token operator\">=</span> <span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  unsigned <span class=\"token keyword\">long</span> thresh <span class=\"token operator\">=</span> lastPlayTime <span class=\"token operator\">+</span> <span class=\"token number\">3600000LL</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// If last play was at least an hour ago,</span>\n  <span class=\"token comment\">// bump esteem</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>now <span class=\"token operator\">></span> thresh<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    lastPlayTime <span class=\"token operator\">=</span> now<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Max esteem is 9</span>\n    esteem <span class=\"token operator\">=</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token number\">9</span><span class=\"token punctuation\">,</span> esteem <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">updateMood</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  voice<span class=\"token punctuation\">.</span><span class=\"token function\">emote</span><span class=\"token punctuation\">(</span>mood<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> Grandbot<span class=\"token operator\">::</span><span class=\"token function\">updateMood</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> last <span class=\"token operator\">=</span> mood<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">int</span> next<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>esteem <span class=\"token operator\">></span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    next <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>esteem <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    next <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    next <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  mood <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">setExpression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>last <span class=\"token operator\">!=</span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Known bug, double emote</span>\n    voice<span class=\"token punctuation\">.</span><span class=\"token function\">emote</span><span class=\"token punctuation\">(</span>mood<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>That’s the code to make him happier. The code to make him sadder (from being ignored):</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token comment\">// Grandbot.cpp</span>\n\n<span class=\"token comment\">// Gets called every loop in main.cpp</span>\n<span class=\"token keyword\">void</span> Grandbot<span class=\"token operator\">::</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> light<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  unsigned <span class=\"token keyword\">long</span> now <span class=\"token operator\">=</span> <span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// ...sleep related stuff...</span>\n  \n  <span class=\"token comment\">// If he's not sleeping or initializing</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mood <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>now <span class=\"token operator\">></span> nextExpressionChange<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">updateEsteem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">setExpression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      nextExpressionChange <span class=\"token operator\">=</span> <span class=\"token function\">getNextExpressionChange</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// ...blinking related stuff...</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// ...more sleep related stuff...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> Grandbot<span class=\"token operator\">::</span><span class=\"token function\">updateEsteem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  unsigned <span class=\"token keyword\">long</span> now <span class=\"token operator\">=</span> <span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  unsigned <span class=\"token keyword\">long</span> thresh <span class=\"token operator\">=</span> lastPlayTime <span class=\"token operator\">+</span> <span class=\"token number\">21600000LL</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// If he hasn't been played with in the last 6 hours</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>now <span class=\"token operator\">></span> thresh<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Need to update this</span>\n    <span class=\"token comment\">// or he'll quickly go from 9 to 0</span>\n    lastPlayTime <span class=\"token operator\">=</span> now<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Minimum esteem is 0</span>\n    esteem <span class=\"token operator\">=</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> esteem <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">updateMood</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So if you play with him once an hour, his esteem will go up by 1 to a max of 9. If you ignore him for six hours, his esteem will go down by 1 to a min of 0. These values need to be stored somewhere else so they’re easy to change.</p>\n<p>The bug I ran into was that he kept waking up unhappy. I intentionally skipped updating esteem while he was sleeping, but as soon as he woke up <code class=\"language-text\">lastPlayTime</code> was greater than 6 hours ago. So when he wakes up:</p>\n<div class=\"gatsby-highlight\" data-language=\"arduino\"><pre class=\"language-arduino\"><code class=\"language-arduino\"><span class=\"token keyword\">void</span> Grandbot<span class=\"token operator\">::</span><span class=\"token function\">wakeup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// So he doesn't wake up angry</span>\n  lastPlayTime <span class=\"token operator\">=</span> <span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// ...wakeup stuff...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It’s not a perfect solution, but it works well enough for me.</p>\n<h4>Code notes</h4>\n<ul>\n<li>The code really needs refactoring. Even though it works as I would hope, it’s a little hard to follow and uses some “magic numbers.”</li>\n<li>There’s a known bug where if you play with Grandbot and he changes moods, he’ll emote twice. Not the worst thing in the world.</li>\n<li>Trying to find the right balance for threshold times is an art not yet mastered. I think six hours is too long, so I’ll probably lower that and tweak the esteem-to-mood numbers.</li>\n<li>I only update esteem when updating expressions (<code class=\"language-text\">nextExpressionChange</code>) because the timing isn’t that important and I don’t want to run it every loop. It’s placing is a little confusing, so I may make a new variable like <code class=\"language-text\">nextEsteemUpdate</code> or rename <code class=\"language-text\">nextExpressionChange</code>.</li>\n</ul>\n<h2>Conclusion</h2>\n<p>I’d like to add more interaction that contributes to his mood. Sensing movement, reacting to date/time, and maybe even making mini-games to play with people. For now though, this is a good start on giving Grandbot his own identity. More and more he’s controlling his own feelings and I’m just trying to keep up!</p>","frontmatter":{"title":"Grandbot Update - Play","date":"May 15, 2020","description":"Interacting with Grandbot to make him happy."}}},"pageContext":{"slug":"/grandbot-update-play/","previous":{"fields":{"slug":"/grandbot-update-voice/"},"frontmatter":{"title":"Grandbot Update - Voice"}},"next":{"fields":{"slug":"/grandbot-update-light/"},"frontmatter":{"title":"Grandbot Update - Light"}}}}}