{"componentChunkName":"component---src-templates-blog-post-js","path":"/grids-bit-shift/","result":{"data":{"site":{"siteMetadata":{"title":"Tech Blog"}},"markdownRemark":{"id":"c15f283a-ea4b-5955-873e-2fb054ffc748","excerpt":"I‚Äôve been having a lot fun building a generative melody sequencer for Grandbot and have started looking at other ways to algorithmically generate parts of music‚Ä¶","html":"<p>I‚Äôve been having a lot fun building a generative melody sequencer for <a href=\"https://github.com/handeyeco/Grandbot\">Grandbot</a> and have started looking at other ways to algorithmically generate parts of music. Passing Grandbot‚Äôs output through my <a href=\"https://github.com/handeyeco/norns-ripchord/\">norns-ripchord</a> has been useful for generating chord progressions and, by using a sampler, I can repurpose Grandbot‚Äôs output to trigger chopped breakbeats for some glitchy D‚Äôn‚ÄôB style drums.</p>\n<p>At one point though I had an idea: what if I took a collections of drum patterns and used them to generate a dataset of probabilities - not a collection of <em>sequences</em>, but a collection of probabilities that could be used to generate novel sequences based on the likelihood that a specific drum would play at a specific step. I knew I would need patterns, that I would need to normalize the data, that this sounded a little like how machine learning works, and‚Ä¶well it all just seemed like a lot of work and maybe a little beyond my skill set.</p>\n<p>So how surprised was I when I discovered <a href=\"https://pichenettes.github.io/mutable-instruments-documentation/modules/grids/\">Mutable Instruments Grids</a> (<a href=\"https://github.com/pichenettes/eurorack/tree/08460a69a7e1f7a81c5a2abcc7189c9a6b7208d4/grids\">source</a>). This is almost exactly how Grids works. Grids is a 5x5 set of pattern probabilities (so 25 patterns) with each pattern containing 32 steps for 3 instruments (bass drum, snare drum, and hi hat); this 5x5 coordinate system is traversed using an X/Y location with the 4 patterns surrounding the X/Y point being combined through a 2D crossfade.</p>\n<p>Before I go any further, I just want to shout out two people: √âmilie Gillet (aka pichenettes) who founded Mutable Instruments and who gave one of the greatest gifts ever be given to the Synth DIY scene by open-sourcing her work. Also a big thank you to Adam Thomas (aka devdsp) who who did a <a href=\"https://devdsp.com/grids.html\">visualization of Grids</a> - one that I borrowed and added to. You can <a href=\"https://handeyeco.github.io/mi-grids-viz/\">find my version here</a>.</p>\n<h2>Understanding Grids</h2>\n<p>Before we get too technical, let‚Äôs talk about what Grids is doing. Grids is called a ‚Äútopographic drum sequencer‚Äù because it‚Äôs working on a 2D map using the concept coordinates (X/Y point) to traverse this map. Kind of like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/74c50a66331cdaf6b96a48c6ab4931de/add4c/4x4-map.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAABlElEQVQ4y6WU3XKCMBBG8/7P04foVe+L4IgoiOAPiCKgs+3JTJwk0im23DAcNvvt5ttEBUEgRVHIZrORPM9lvV4LbLvdasZ7tVqJHWfYbDZz1i6XS1EA+7nf73I4HBx2u93keDw6bBgGqarKYV3XiSK7SWRgWZYOu16vo2y32znscrmIonxf2QSap+972e/3T9X4nbRtKypNU61AAMlQoWoYiWj3fD7rPbJZ0zR6L+21dV2LCsNQ7w9VocjCKIochsAYm8/nDqO4J1NQ99tD3W8P5hulTaGi30zp++5/ptgVvr0H8vGZSNvUT0b5VSOiGGTa5IMgDMiyTCcehl7irJQ0L6X4FoYRx/t0Oun9ttcyl44pVEaQYbTZ1JVOFobRg1EZosYUGGtHTRk7KS+Z8teTwhBPMmXq2LBnfoXalDiOtRqTjyEEJUnyYKiSjNvFZogahkGspWK1WCz0B8eGHwQiYhgJCORq8hnC9lr8+PNJGWv5R1OMyKumUO3kC3by2HCNE2yGk4oZbJsxxGOMG8hmnLovaEgKTYdse6oAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"4x4 grid with a single point at 2x2\"\n        title=\"4x4 grid with a single point at 2x2\"\n        src=\"/tech-blog/static/74c50a66331cdaf6b96a48c6ab4931de/fcda8/4x4-map.png\"\n        srcset=\"/tech-blog/static/74c50a66331cdaf6b96a48c6ab4931de/12f09/4x4-map.png 148w,\n/tech-blog/static/74c50a66331cdaf6b96a48c6ab4931de/e4a3f/4x4-map.png 295w,\n/tech-blog/static/74c50a66331cdaf6b96a48c6ab4931de/fcda8/4x4-map.png 590w,\n/tech-blog/static/74c50a66331cdaf6b96a48c6ab4931de/efc66/4x4-map.png 885w,\n/tech-blog/static/74c50a66331cdaf6b96a48c6ab4931de/c83ae/4x4-map.png 1180w,\n/tech-blog/static/74c50a66331cdaf6b96a48c6ab4931de/add4c/4x4-map.png 1452w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Okay, so I don‚Äôt know whether to call this a 5x5 or 4x4 grid; the lines represent the 25 drum patterns (5x5) but the coordinates exist within the 4x4 space between lines. If I make a mistake, chalk it up to a classic off-by-one error. Anyway let‚Äôs zoom in:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/3a01fb8e933088213c2d524e06a8a6d3/b79a5/one-cell.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAACLklEQVQ4y5VU227TQBD1B4EEv4L4DN5BCPEB8AAPpCSVKBLlsWoREuLaOHEce23HieOkzQXHpRUKCiGVobmUxslh14lTN7XdMNLRjmbmHO3Mjpbb268htfEchX0CYohQyvlLUE2ZnlJojhh5j7u+kUS1WgOX2d5GKpmEWTGhFTToemGBAjuLOogq0ZxKY/osFgDjMG5qPQXh01twfdOEpGmIM9upYYJxbI1MNIw6TXAdVcGuIHjB8XiMyWSygOu6wBT44XzH4LSPKfVZLFjDOMzSfBa/DsrguvR2fC7nBVnBsk2ZSojvm8/hszkcH1aiBRnZF1j2VxdkLQZIcYL+GS8YIK5qlwR/qioyhGBqWThznMhZRc3W/TsEeg3wmSwVrJ7fsPf4EUa2PSsOeZyoEZyddOE23i0JiiLQ72M8HEbeMCjmspVia8PWaPQHGHbAC+L/zzAs586bWemVl8X8+M6HDO4/2UTja2uRv3IPw9pkpulF3LjzCtcfyrh1Nwn3dLD6Ygd9d95bQS/hJhW89iCP2/dSVwv6rQWx2Lm5/+YjbfnpJppWSMtsD9MRn8Nkfqv2kYMj+3j2CO7FsSw+h4yA3jcT3O9SCaJCYpe4fXiCutGNrclLBIN2HdyXrS0kniVQpLORJBmEKHPQH1wmUBT6vX0WwO/mPJ/FzmsUyJSj04daS6wh/X4HnHXQwssXr1Et2zD0Osp64wIMiorR9GAs5Wb5OqqG7WlYLQv/ACT4ytT8uamGAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"One cell of the 4x4 grid with each edge as a drum pattern\"\n        title=\"One cell of the 4x4 grid with each edge as a drum pattern\"\n        src=\"/tech-blog/static/3a01fb8e933088213c2d524e06a8a6d3/fcda8/one-cell.png\"\n        srcset=\"/tech-blog/static/3a01fb8e933088213c2d524e06a8a6d3/12f09/one-cell.png 148w,\n/tech-blog/static/3a01fb8e933088213c2d524e06a8a6d3/e4a3f/one-cell.png 295w,\n/tech-blog/static/3a01fb8e933088213c2d524e06a8a6d3/fcda8/one-cell.png 590w,\n/tech-blog/static/3a01fb8e933088213c2d524e06a8a6d3/efc66/one-cell.png 885w,\n/tech-blog/static/3a01fb8e933088213c2d524e06a8a6d3/c83ae/one-cell.png 1180w,\n/tech-blog/static/3a01fb8e933088213c2d524e06a8a6d3/b79a5/one-cell.png 1372w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This point exists in a space between 4 drum patterns - or rather drum <em>probability</em> patterns. These probability patterns are blended together based on the position of the X/Y point. In this case it will be affected by all 1-4 patterns, but it will be affected by 2 and 3 more than 1 and 4.</p>\n<p>To illustrate this, let‚Äôs look at just 4 steps of one of the three instruments while pretending that each pattern has its own step. Note that each pattern‚Äôs step is a dark color (indicating a high probability) but that the outputs for 2 and 3 are darker than 1 and 4 (indicating a bias towards 2 and 3 probabilities). However the steps for 1 and 4 still have <em>some</em> probability.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/fa4e3fd9672750e84d958faf429e7dac/86a1e/simple-blend.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 114.1891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABYlAAAWJQFJUiTwAAAEbUlEQVQ4y2VUa0ybZRT+MDE4MyNBSMBo3KKRRU3MJgZMZpSZsc1LXEx0S0kYUC6NjsSlRoiCJRJd9Adm0Xn7A9apf8yU1ZAw+cPglzGAQG+09E5bCi290nsfz3lLP4qe5OR73/Od93nPOe9zjtT1wQW0djfjpc5GqK+q4HQ4sbGxAZ/PB4/HA7vdLu+9Xi/W19eFnddsczqdSCVTYCkUCpCePF+Poy8fxsNnKtGsaIDRZES5rKysHNivra0hFovJ+3gsDv+2F5l8WuylE28exbHXa/DYq/fjxY6nYTDq+S7kshlkM2kZkG9nsVgsiEajMmAsGoNvy4NUbrcI2PjWozhy9jAeOn0PpX0CTvfGgYjMaxak02lkMhnk83kBGA6HkcvlkM/lEQqF5IhFylMzOvz8mxY3fh3H3F9zmJ++ie8/VmHisyuY+FwNs2EFJpMZRqMRer1e1JBBDQaDsLGm0ul9wN1EUo4mT6pRPAPVMQlXnpXQ0yBh8sfr4l+WIhQRm80iwpJwhJFIeB8wEolQxQqUThbpHPBp50kMnKyA5lw11M9J0P30tXDOZNJyDcsfJRpPImRfRCG+WaxheYHTFKLm4nG884QEdbOEPop0UvvVgZparRZwECWJRKIIbxNYIQd+NslkMoHVQPVxuNyYuTmBa+9dwDdDHfj2IyX0S3/j9vQd/DH5J279Po3lf1Zhs62LGvK5Yg0z+ykHg0Ekk0mhwe1temVv8edeBL/c0KGmsgVHHngF1Xe34NLFQUo/iUQ8gVQqha2tLcTjZa98oB6U/prZJOCyezW7fu0H1FaexuMPvoG6e8/g/NnLZM3tE5vAbBYvYpE9YicSibKfcdEJ5fLlFxO4T3oBj1S/hqq7TuFcS29Z/EAiEYfL4Udyt3iJ5HA4RK9yf7rdbiq6VaxZNzd9mLk9h+cbL+FUsxJNTylwdfQ7BENUGjrnIX8H9XKJASJlbm5udAZlQKYFr9nmcrloONjg9/toEHjF1+Gw45PWVqhqa/F2XR0+bGpCJFx89QJ10v9SZsByWV5ePrBfXVpCf00NlBIRn/XQIdjm5kCvWqTNfx+lHJBTWF1dlW9n0dMF79bXo5vAeklVVVWwTk0BOztFwG2iCjc/K1OAW6tEIyYw840j300UaWKk/fsNDegisO6KClymtAN+f7F1aWCITuF+ZOWDDMxR85o1m83Ka/bN0qEA13pxEVZSHw3gUgYysQOBAL3opoiIvwsLC1gkZ06XbTwTl6h2bGffGIEHKcUQDYkdngV7s1IA8ojnVP0UNoMNDw9DoVCgq6sLHR0dGBsbQ2dnp9i3tbVhZGRE+PL4D5A/jzPOriQS842j2OEb6cfg4KAAUKlU6O3txejoKPr6+sSe7UNDQ+Cs2J/PMb2YCbOzs5ifn4fEnOP6lEDVajXa29sFGEel0WigVCrR09Mj7AMDA8KP68nnSpzlwJjTYtowVfjLRB4fH0d/f78A5sM6nU58ec92rVYrDjIb+BxPG2ZESf4FOYAJfeLgQgkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Simple blending example showing blending bias towards 2 and 3\"\n        title=\"Simple blending example showing blending bias towards 2 and 3\"\n        src=\"/tech-blog/static/fa4e3fd9672750e84d958faf429e7dac/fcda8/simple-blend.png\"\n        srcset=\"/tech-blog/static/fa4e3fd9672750e84d958faf429e7dac/12f09/simple-blend.png 148w,\n/tech-blog/static/fa4e3fd9672750e84d958faf429e7dac/e4a3f/simple-blend.png 295w,\n/tech-blog/static/fa4e3fd9672750e84d958faf429e7dac/fcda8/simple-blend.png 590w,\n/tech-blog/static/fa4e3fd9672750e84d958faf429e7dac/efc66/simple-blend.png 885w,\n/tech-blog/static/fa4e3fd9672750e84d958faf429e7dac/c83ae/simple-blend.png 1180w,\n/tech-blog/static/fa4e3fd9672750e84d958faf429e7dac/86a1e/simple-blend.png 1296w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Now let‚Äôs look at a more likely example. In the next diagram:</p>\n<ol>\n<li>All patterns have a high probability for step 1 which means the output for step 1 has a high probability.</li>\n<li>Similarly, all patterns have a 0% chance probability for step 2, so the output for step 2 has a 0% probability.</li>\n<li>Pattern 3 has a medium probability for step 3, pattern 4 has a low probability, and patterns 1 and 2 have a 0% chance; I didn‚Äôt do that math, but that should result in a low-to-medium probability since pattern 3 pulls it up and pattern 2 pulls it down.</li>\n<li>Finally step 4 output is a very low probability because patterns 1 and 4 have some probability, but that‚Äôs brought down by patterns 2 and 3 having a 0% probability.</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/301b25e5de1131f3ef4acb10c338f13c/5f652/complex-blend.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 112.83783783783782%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABYlAAAWJQFJUiTwAAAE/klEQVQ4y2VVa0ybVRj+FhMR55RoApRFmBm7Gfyhm9nQbLqJGQLD6ByDbeIyHXMsIRjDELdsEDXLEszcYjYzjWaSGLLEH2aKXFfCrTfoBaS0XNpSWkrbr+Xecu3j+36FMvS0b8739pzvOed53kuF06UfYG/ODuzL3Ym8z7JgNpswOjoKh9OBkZERDAwMSLPT6SRzwGYZxu9tVaj880vcqq3AjQdX4RKd4LG8vAzh1dxkbMnYiK1Zz2BnViw0WhUeHUajUdq4OhwjTtx9eB03O8pwW1mOa3XF0FtUCNGHv0Jq3nZsfecpbCPAlGwZOnXqyGlsfX19WFhYiACO2B34SV6JW+2XcFtRget1n0M3pMRiKLxHSCtIxc6jm/Hiseex78OXoO/RSQvz8/OYm5uDyWRCIBCQQPkAh92Jn+U3UCkvwc2Wy/jmr2IMOc1rlL/7uhCFJ3aj8OQefFtRAJvVht7eXgmI6VqtVumZb9pr7MXg4BAMRh0aFX+jWdMAubIBk1NTEmAoFIJQnrUZpfsElL0m4OLBTejWhikvLS1icXFRAuXbrupotVnhcXsiEsxOBzA+7me4MOCVdxNRsv8xlL7xOEreikGP9r8amlYAQ9Lvw7ZhuN1jK3AhTM3Mwj86hGW/hWMC4WpWHMpeF3DpgICSN59Ad9f6KDP9R8eIw06A7rUbBoLwe+mApUAY8E55MUqPH0Rp7iF8f/kCbESJdbJYhmgeJN+GLvU/ULYboGjVo6fbhOHhYWmN9TWbzZienlnT8MDec4h/OhMJMUewJyUfBn0PJicn4fWKmJjwo1WuwUfpd3Hi0A/I2X8HF8/eo8R3wO/3k3bjcDgctG9iDXD3jjwkxmTgheeOYLvsCDRq3cpimFJ9TQfOZf+GC+/fx6fZ91F08hf4fGKEcjAYgGvUC587EM7DlC1HERv1NmRPpiPx2cNQq7rWaVb7oA1n0qtQkFmNjw9X4/yxHyGK3vWATg/GxWAYMD/vCva+fBqpr5xBzntfkCYD8Hg8Uj17PGPQdvYSzWoUnapC4fFfKVf/gMvtwhiljtvrhZ3qfHp6eo3ytcwMnJfJUJiwGV+lpWGAmoPdbpfMSgEZJL//YRPM9Q0w19XBrGhHv1IJU20tBpqa0FNTgwmfLwzIlXIhJgZnBAGfkJ3esAE6hWId5R6NBlMqFeZ0Wizp9TDV1cPe1oZFnQ4L5HtaWuClSNM1w2lTLEvAWQI7J2xAwcaN6FaF83B5aUnaYNRqMa5UYaazE0F6Njc2wt7RgWBXFwLku9vb4e7UYKG/P6xhUUICThFgPt9y0yYY6EWpOVBjmKOG0E2+p7UV43TzKaJqbGjAEPmT5E/S4XbyfS7XGmU71aqRNrDZqSq4s4gkto90EUVR8v1jYxCpwXopAFOUe2we0thLOShS8LjmOc+koIxSGfXRdY1kLnrmRQbixGVbYJ9mN0We12dmZxEIBiHSgT5Obkrq1cYhta9tyckQiC6bLD4eOhKbF/hmQXqR/TYKgoJ0UxDNRtLQYrFIDPxkXJq+lShLGsbGxkYAo6KioFoJSmilVLpIfCVpx7OWglBfXy/VMh82S7f1kjz8v9Pc3AyDwQAhLi4uAhgdHf0/QAZRq9XSrKc0aaAgcI5yN2cWXAT8B8bNghuFsGvXrghgUlKS9BI3By58psKUmyiB+QZyuVwC5Be5KXA1cTdnrVfHvzyh1C31P3rxAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Complex blending example showing how patterns interact with one another\"\n        title=\"Complex blending example showing how patterns interact with one another\"\n        src=\"/tech-blog/static/301b25e5de1131f3ef4acb10c338f13c/fcda8/complex-blend.png\"\n        srcset=\"/tech-blog/static/301b25e5de1131f3ef4acb10c338f13c/12f09/complex-blend.png 148w,\n/tech-blog/static/301b25e5de1131f3ef4acb10c338f13c/e4a3f/complex-blend.png 295w,\n/tech-blog/static/301b25e5de1131f3ef4acb10c338f13c/fcda8/complex-blend.png 590w,\n/tech-blog/static/301b25e5de1131f3ef4acb10c338f13c/efc66/complex-blend.png 885w,\n/tech-blog/static/301b25e5de1131f3ef4acb10c338f13c/c83ae/complex-blend.png 1180w,\n/tech-blog/static/301b25e5de1131f3ef4acb10c338f13c/5f652/complex-blend.png 1302w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>So which notes play? That‚Äôs where the ‚Äúfill‚Äù control comes in. Fill is basically a threshold for triggering a gate. If the output probability is higher than the fill threshold, the gate is triggered. In the next diagram, I‚Äôll indicate notes that don‚Äôt play with blue and notes that do play with orange. The probabilities stay the same each time, but as the threshold drops more notes play.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/3ef5e4599989b7deaf24e57f5da2660b/f43e4/threshold.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 118.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAABYlAAAWJQFJUiTwAAAFPElEQVQ4y22Va1BUdRjGT05TH+xLly/ZB5ucqRkjLcVL6KSGjZpjNaapo6nZOGbmvUwB8R5qykUEFdgFFTQZFQZCBUHdC6zKrhLBsgi7srvsFVZEQECEX/9zFIT0zLx79tye87zP83+fI/X09NB/6+7uVvYPHrRQVVWF0WjEYrHQe1//+1/0X5J//D4fToed9vaHyskGvw+btZZ79wI8fPgQm81KbW2N/Jhyva2tjcbGxj6g3lIAOzo7KbqmI/dCPlZbnXLS+I+Zi4UaXF6/cmwqK+fS5SKaW1qVY4/Hg9lsfiFLKSw2g1fHLOGNSSsJWRhG5AkdU/boCI3SsyShhPN6C2qtE5XGzimdDafLQ0d7u8KyqamJrq6ugS0vizyKNHwBg4J/4L0Zq1kaW8iYHSV8uquYr6Ovk1pUjbrYh7rEx3GdU7Bu7GP0+PFjRefc3FwqKiqeAC4OT0B6dzZS0EKGfL6CRQcLCIrQ83Gknmn7ilEVVpOs85EkSqVx4PI9A+wUcrndbqxWa5+mUvZVE7PXRzNnYwwRh89QYLrLlpM3Ccso5Vi+mXKrm79v3iXPWIe2wikeDAiz7inVCzJAQ+3ZROKWjSZ+xQQyd8zjZMFtVqhMrFQZ2XOunOJKJ9lGF1ml9RSU1dMYuCecb6OltZXm5ubnTUkOm8+qIIl1YyV2TX+NJXvPERRpYNQ2uWU9SfmVJOt9ovykXKvD4fYNaNlms6HRaJS90nKKAPzlKeDu6YNZujeTkZHFBEdqmLFPR7IMqGjoFYD2AYCPHj1SgEpKSnA4HE8Ai84k8OeS0UQvn0D61u8EgJkFSWYWJVey5ewdis1usoxusk1e8svcSssyM7laWloUp/tvkvFqDvG/ziVh0zwyE3ZQb8ylOmMtllMbcBZEU2mtJ69UmHLThl7o2WuG3+9/zpRWoavS8s/DJTYES2z64i00+7/Bve996vd/iD02hPS8Yo7qG0nSep5rWWYpv0Ce9fv371NeXo6k3rqQdaMkNk+UCJv5DvoDs2mIGYk3LhjX4clkFlxHZQiQVuwlTWvH7Q8M0FAew5ycHGpqaqiurkbKStzK71NfJ2Lm2+xfPglTRhh3YqdQHTcVq3ohFwxmwc6LSufhtMGFW8x3R0e7CJJ2ZfT6aygzlSqNWo5HrebE3jVcPJVAvdlA+dnd/HtuD7WadFx1d6i6WYSl9Cp3K0sVkEAgQENDg9Ju/9iTGUupkd+z+iOJ38ZLbPlyCPqYefgPDscXPQJbfCjmvHgRP0dEHaVRI15ot/WByCxl8P7AUuq2xawXhmz+bBDhs4aij56LN+YT3LHB2BKmYbkQT2dpCo+MKTTojuGtr3s6Fd1KuyaTiStXrvQFs5T+x09sHCcMmfIK2+d8gCFxGR4B5jk0HtvRWVjykwSYii6TigZ9Cl6Xo4+NHL5yyRHWF19Vtw2kRq0lLWoNl/46hqvahClzN7dEWa6dxi00NGvPY9ZlYS3T0iSWh7wGfSLl+6/D3tSWTu9fzcaQlwgLHczO+SO4kbQSZ8w4HHEh1B6bjeWymrbrybTdEOx0KtxOOzIZmZUcsvJaHACYJjTcKOY4fPLLRHwlaziHhrhR+A6NpS5xutDwEN231PTcVhPQJ+Hr17LsqsFgUJx/ljbhC/hxmMQq4fSG0DfRHviWup1Dubt7GJaDE6nIjaVVF0ubKHdhnHDZqnyquoUh8izLEdZriAJouaUj+0gkOUnbuZalxl1VQl1hAvbCROpvnMNvt+Cr1OAza/DXlNIsNJRblUue3f9/Xv8DmBsjnXtjwlsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Diagram showing that as threshold decreases, likelihood of notes playing increases\"\n        title=\"Diagram showing that as threshold decreases, likelihood of notes playing increases\"\n        src=\"/tech-blog/static/3ef5e4599989b7deaf24e57f5da2660b/fcda8/threshold.png\"\n        srcset=\"/tech-blog/static/3ef5e4599989b7deaf24e57f5da2660b/12f09/threshold.png 148w,\n/tech-blog/static/3ef5e4599989b7deaf24e57f5da2660b/e4a3f/threshold.png 295w,\n/tech-blog/static/3ef5e4599989b7deaf24e57f5da2660b/fcda8/threshold.png 590w,\n/tech-blog/static/3ef5e4599989b7deaf24e57f5da2660b/efc66/threshold.png 885w,\n/tech-blog/static/3ef5e4599989b7deaf24e57f5da2660b/f43e4/threshold.png 1120w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Just a disclaimer, this is more meant to be a conceptual example not a precise description of how the code works. Anyway let‚Äôs recap the ideas:</p>\n<ul>\n<li>We have 25 (5x5) drum probability patterns that are formed to create a 4x4 grid</li>\n<li>We traverse this grid using an X and Y position</li>\n<li>We blend the 4 patterns that surround the X/Y position in a way that‚Äôs biased towards the patterns we‚Äôre closest to</li>\n<li>We read steps from this blended probability pattern and compare each step to a threshold to determine whether or not the step should trigger a gate</li>\n<li>We do this for 32 steps for 3 instruments (sharing the X/Y coordinate but with each instrument having its own fill setting)</li>\n</ul>\n<p>If things still aren‚Äôt clicking, play around with the visualizer that Adam Thomas made and which I modified to add a visualization of the coordinate grid: <a href=\"https://handeyeco.github.io/mi-grids-viz/\">here‚Äôs that link again</a>.</p>\n<p>Whew that was a lot. What‚Äôs this blog post about again? Right, bit shifting.</p>\n<h2>Understanding Grids‚Äô bit shifting</h2>\n<p>At this point you might be thinking we‚Äôre about to dig into an encyclopedia‚Äôs worth of code in order to work in this blended, multi-dimensional space - at least that‚Äôs what I was thinking. If so, you‚Äôll be surprised to discover that the reading/blending code is relatively concise (if a little opaque).</p>\n<p>I‚Äôm sure a lot went into the machine learning data crunching, but accessing and blending the data can be cleverly done with a few lines of code thanks to some <a href=\"https://en.wikipedia.org/wiki/Bitwise_operation\">bitwise operators</a>. Coming from JavaScript this was a novel idea - it‚Äôs rare that we need the speed or control that bit manipulation offers and numbers in JS are floats anyway so it‚Äôs not as straightforward as it is in C++.</p>\n<p>Let‚Äôs look at the code. First we‚Äôll make the 5x5 grid:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// pattern_generator.cc</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">const</span> prog_uint8_t<span class=\"token operator\">*</span> drum_map<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">{</span> node_10<span class=\"token punctuation\">,</span> node_8<span class=\"token punctuation\">,</span> node_0<span class=\"token punctuation\">,</span> node_9<span class=\"token punctuation\">,</span> node_11 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> node_15<span class=\"token punctuation\">,</span> node_7<span class=\"token punctuation\">,</span> node_13<span class=\"token punctuation\">,</span> node_12<span class=\"token punctuation\">,</span> node_6 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> node_18<span class=\"token punctuation\">,</span> node_14<span class=\"token punctuation\">,</span> node_4<span class=\"token punctuation\">,</span> node_5<span class=\"token punctuation\">,</span> node_3 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> node_23<span class=\"token punctuation\">,</span> node_16<span class=\"token punctuation\">,</span> node_21<span class=\"token punctuation\">,</span> node_1<span class=\"token punctuation\">,</span> node_2 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> node_24<span class=\"token punctuation\">,</span> node_19<span class=\"token punctuation\">,</span> node_17<span class=\"token punctuation\">,</span> node_20<span class=\"token punctuation\">,</span> node_22 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Each node here is is an array of 96 probabilities - 3 instruments (BD, SD, HH) times 32 steps - and each probability is represented as a byte (0-255). Now we‚Äôll read a specific step (0-31), for a specific instrument (0-2), for a specific X/Y position (0-255 / 0-255):</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// pattern_generator.h</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token keyword\">uint8_t</span> kStepsPerPattern <span class=\"token operator\">=</span> <span class=\"token number\">32</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// pattern_generator.cc</span>\n\n<span class=\"token keyword\">uint8_t</span> <span class=\"token class-name\">PatternGenerator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ReadDrumMap</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">uint8_t</span> step<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">uint8_t</span> instrument<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">uint8_t</span> x<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">uint8_t</span> y<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">uint8_t</span> i <span class=\"token operator\">=</span> x <span class=\"token operator\">>></span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">uint8_t</span> j <span class=\"token operator\">=</span> y <span class=\"token operator\">>></span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> prog_uint8_t<span class=\"token operator\">*</span> a_map <span class=\"token operator\">=</span> drum_map<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> prog_uint8_t<span class=\"token operator\">*</span> b_map <span class=\"token operator\">=</span> drum_map<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> prog_uint8_t<span class=\"token operator\">*</span> c_map <span class=\"token operator\">=</span> drum_map<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> prog_uint8_t<span class=\"token operator\">*</span> d_map <span class=\"token operator\">=</span> drum_map<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">uint8_t</span> offset <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>instrument <span class=\"token operator\">*</span> kStepsPerPattern<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> step<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">uint8_t</span> a <span class=\"token operator\">=</span> <span class=\"token function\">pgm_read_byte</span><span class=\"token punctuation\">(</span>a_map <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">uint8_t</span> b <span class=\"token operator\">=</span> <span class=\"token function\">pgm_read_byte</span><span class=\"token punctuation\">(</span>b_map <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">uint8_t</span> c <span class=\"token operator\">=</span> <span class=\"token function\">pgm_read_byte</span><span class=\"token punctuation\">(</span>c_map <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">uint8_t</span> d <span class=\"token operator\">=</span> <span class=\"token function\">pgm_read_byte</span><span class=\"token punctuation\">(</span>d_map <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">U8Mix</span><span class=\"token punctuation\">(</span><span class=\"token function\">U8Mix</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> x <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">U8Mix</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> x <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> y <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// In a shared utility repository</span>\n\n<span class=\"token keyword\">uint8_t</span> <span class=\"token function\">U8Mix</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint8_t</span> a<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint8_t</span> b<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint8_t</span> balance<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> a <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">255</span> <span class=\"token operator\">-</span> balance<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> b <span class=\"token operator\">*</span> balance <span class=\"token operator\">>></span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If you look at this and think ‚Äúyeah, that makes sense‚Äù then I wasted your time. I‚Äôm sorry. The rest of this article is just going to explain these 20-ish lines of code.</p>\n<p>First let‚Äôs describe this with pseudocode:</p>\n<ol>\n<li>We declare a function called <code class=\"language-text\">ReadDrumMap</code> that accepts 4 bytes: <code class=\"language-text\">step</code>, <code class=\"language-text\">instrument</code>, <code class=\"language-text\">x</code>, and <code class=\"language-text\">y</code>.</li>\n<li>We use <code class=\"language-text\">x</code> and <code class=\"language-text\">y</code> to get indices (<code class=\"language-text\">i</code> and <code class=\"language-text\">j</code>) that we then use to get pointers to 4 patterns from <code class=\"language-text\">drum_map</code>.</li>\n<li>Since each node in <code class=\"language-text\">drum_map</code> is an array of 96 probabilities and each of the three instruments takes up 32 of those 96 slots, we multiply <code class=\"language-text\">instrument</code> by <code class=\"language-text\">kStepsPerPattern</code> (32) and then apply the <code class=\"language-text\">step</code> offset to get our final index <code class=\"language-text\">offset</code>.</li>\n<li>We then get the probability for that instrument/step from each of the 4 patterns (<code class=\"language-text\">a</code> - <code class=\"language-text\">d</code>).</li>\n<li>Finally we blend the 4 bytes representing the 4 probabilities into 1 byte.</li>\n</ol>\n<p>But wtf is <code class=\"language-text\">x &lt;&lt; 2</code>? How does <code class=\"language-text\">x >> 6</code> convert a byte into a 0-3 index? Why do we need <code class=\"language-text\">>> 8</code> at the end of <code class=\"language-text\">U8Mix</code>? This is the power of bit-shift operators. üåà</p>\n<h3>Mapping 0-255 to 0-3</h3>\n<p>The first bit-shift operation we hit is <code class=\"language-text\">uint8_t i = x >> 6;</code>.</p>\n<p>We know that <code class=\"language-text\">x</code> and <code class=\"language-text\">y</code> are values between 0 and 255, but we want to map this to 0-3 to get our first x- and y-patterns from <code class=\"language-text\">drum_map</code> (which we can use to get our second x- and y-patterns by adding 1 to the indices). What I probably would have done was use Arduino‚Äôs map:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">long</span> <span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> x<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> in_min<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> in_max<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> out_min<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> out_max<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">-</span> in_min<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>out_max <span class=\"token operator\">-</span> out_min<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>in_max <span class=\"token operator\">-</span> in_min<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> out_min<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">map</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>However, division is pretty inefficient which could be a problem in time-sensitive applications. Here‚Äôs a quote from √âmilie that hints at her motivation for using bit shifting:</p>\n<blockquote>\n<p>‚Ä¶you need to divide by 255 instead of shifting by 8, and what took 1 CPU cycle will suddenly take 40+</p>\n<p>(<a href=\"https://handeyeco.github.io/mi-grids-viz/\">source is on my visualizer clone</a>)</p>\n</blockquote>\n<p>That‚Äôs where bit shifting comes in. But what does a right shift do? Let‚Äôs look at some code.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">byte a <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// decimal 0   is 00000000 as a binary byte</span>\nbyte b <span class=\"token operator\">=</span> <span class=\"token number\">64</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// decimal 64  is 01000000</span>\nbyte d <span class=\"token operator\">=</span> <span class=\"token number\">128</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// decimal 128 is 10000000</span>\nbyte e <span class=\"token operator\">=</span> <span class=\"token number\">192</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// decimal 192 is 11000000</span>\nbyte f <span class=\"token operator\">=</span> <span class=\"token number\">255</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// decimal 255 is 11111111</span>\n\n<span class=\"token number\">255</span> <span class=\"token operator\">>></span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 11111111</span>\n<span class=\"token number\">255</span> <span class=\"token operator\">>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 01111111</span>\n<span class=\"token number\">255</span> <span class=\"token operator\">>></span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 00111111</span>\n<span class=\"token number\">255</span> <span class=\"token operator\">>></span> <span class=\"token number\">7</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 00000001</span>\n<span class=\"token number\">255</span> <span class=\"token operator\">>></span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 00000000</span></code></pre></div>\n<p>Some things to note:</p>\n<ol>\n<li>Bit-shifting right moves all of the existing bits right, drops the right-most bit, and prepends the byte with a 0.</li>\n<li>As we move from 0 to 255, the left-most two bits have 4 distict states: <code class=\"language-text\">00</code>, <code class=\"language-text\">01</code>, <code class=\"language-text\">10</code>, and <code class=\"language-text\">11</code>.</li>\n<li>Counting 4 steps is exactly what we need.</li>\n</ol>\n<p>So enough being coy, let‚Äôs do the thing.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">  <span class=\"token number\">0</span> <span class=\"token operator\">>></span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 00000000 becomes 00000000 = 0</span>\n <span class=\"token number\">64</span> <span class=\"token operator\">>></span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 01000000 becomes 00000001 = 1</span>\n<span class=\"token number\">128</span> <span class=\"token operator\">>></span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 10000000 becomes 00000010 = 2</span>\n<span class=\"token number\">192</span> <span class=\"token operator\">>></span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 11000000 becomes 00000011 = 3</span></code></pre></div>\n<p>Since bit-shifting right drops the right-most bits and prepends the byte with 0, we will always end up with 0-3 when keeping only two of the bits. By using the most significant bits (MSB), 0-3 maps fairly evenly across 0-255</p>\n<h3>Reclaiming 6 bits</h3>\n<p>While we want to be able to blend our 5x5 grid, we don‚Äôt just want 16 (4x4) steps of resolution - that‚Äôd be boring! <code class=\"language-text\">x</code> is 0-255 and <code class=\"language-text\">y</code> is 0-255, so we <em>should</em> have 65,025 possibilities. So that‚Äôs why we blend between patterns. However we‚Äôre already using 2 bits for the indicies.</p>\n<p>Here‚Äôs where the next shift happens: <code class=\"language-text\">x &lt;&lt; 2</code>. With a left bit shift, we drop the left-most bit and add a 0 to the right of the byte.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">255</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 11111111</span>\n<span class=\"token number\">255</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 11111110</span>\n<span class=\"token number\">255</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 11111100</span>\n<span class=\"token number\">255</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">7</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 10000000</span>\n<span class=\"token number\">255</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 00000000</span>\n\n  <span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 00000001 becomes 00000100 = 4</span>\n  <span class=\"token number\">2</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 00000010 becomes 00001000 = 8</span>\n  <span class=\"token number\">3</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 00000011 becomes 00001100 = 12</span>\n<span class=\"token number\">253</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 11111101 becomes 11110100 = 244</span>\n<span class=\"token number\">254</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 11111110 becomes 11111000 = 248</span>\n<span class=\"token number\">255</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 11111111 becomes 11111100 = 252</span></code></pre></div>\n<p>Note that it moves in increments of 4 when we shift by 2, which gives us 64 steps between 0 and 255. However this is 64 steps <em>per</em> section in the 4x4 grid; 64*4 is 256 which is the number of steps from 0-255. We‚Äôre back baby!</p>\n<p>So <code class=\"language-text\">x >> 6</code> helps us break 0-255 into 0-3 and <code class=\"language-text\">x &lt;&lt; 2</code> helps us get a 64 step resolution within a single section of the 4x4 grid. Together they let us traverse seemlessly while also letting us access the <code class=\"language-text\">drum_map</code> gracefully.</p>\n<h3>Scaling up, scaling down</h3>\n<p>This final bit of bit shifting is <code class=\"language-text\">balance >> 8</code> in <code class=\"language-text\">U8Mix</code>. For that it‚Äôs useful to look at the whole function again:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">uint8_t</span> <span class=\"token function\">U8Mix</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint8_t</span> a<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint8_t</span> b<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint8_t</span> balance<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> a <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">255</span> <span class=\"token operator\">-</span> balance<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> b <span class=\"token operator\">*</span> balance <span class=\"token operator\">>></span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It‚Äôs a crossfade between <code class=\"language-text\">a</code> and <code class=\"language-text\">b</code> where <code class=\"language-text\">balance</code> is the mix between the two. They‚Äôre all bytes, so they all have a range between 0 and 255.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token function\">U8Mix</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 255 - balance = 255 - 0 = 255</span>\n<span class=\"token comment\">// a * 255 = 0 * 255 = 0</span>\n<span class=\"token comment\">// b * balance = 255 * 0 = 0</span>\n<span class=\"token comment\">// 0 + 0 = 0</span>\n<span class=\"token comment\">// 00000000 >> 8 = 00000000</span>\n<span class=\"token comment\">// U8Mix(0, 255, 0) = 0</span>\n\n<span class=\"token function\">U8Mix</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span> <span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 255 - balance = 255 - 255 = 0</span>\n<span class=\"token comment\">// a * 0 = 0 * 0 = 0</span>\n<span class=\"token comment\">// b * balance = 255 * 255 = 65025</span>\n<span class=\"token comment\">// 0 + 65025 = 65025</span>\n<span class=\"token comment\">//     65025 is bigger than a byte!!!</span>\n<span class=\"token comment\">//     We need two bytes to represent it</span>\n<span class=\"token comment\">// 1111111000000001 >> 8 = 11111110</span>\n<span class=\"token comment\">// U8Mix(0, 255, 255) = 254</span>\n\n<span class=\"token function\">U8Mix</span><span class=\"token punctuation\">(</span><span class=\"token number\">37</span><span class=\"token punctuation\">,</span> <span class=\"token number\">145</span><span class=\"token punctuation\">,</span> <span class=\"token number\">36</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 255 - balance = 255 - 36 = 219</span>\n<span class=\"token comment\">// a * 219 = 37 * 219 = 8103</span>\n<span class=\"token comment\">// b * balance = 145 * 36 = 5220</span>\n<span class=\"token comment\">// 8103 + 5220 = 13323</span>\n<span class=\"token comment\">//     13323 is bigger than a byte!!!</span>\n<span class=\"token comment\">//     We need two bytes to represent it</span>\n<span class=\"token comment\">// 0011010000001011 >> 8 = 00110100</span>\n<span class=\"token comment\">// U8Mix(37, 145, 36) = 52</span></code></pre></div>\n<p>So here‚Äôs what‚Äôs happening:</p>\n<ol>\n<li>We scale <code class=\"language-text\">a</code> up by the inverse of balance</li>\n<li>We scale <code class=\"language-text\">b</code> up by balance</li>\n<li>We add the two scaled numbers up, which may exceed a byte</li>\n<li>We shift the whole thing right by 8 bits, which scales the number back down to a byte</li>\n</ol>\n<p>So in a sense, <code class=\"language-text\">n >> 8</code> is an imperfect equivalent of <code class=\"language-text\">n / 256</code>, one that‚Äôs close enough to use in exchange for the added performance boost that comes from avoiding division.</p>\n<h2>The whole thing</h2>\n<p>So let‚Äôs go through the whole thing.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token function\">ReadDrumMap</span><span class=\"token punctuation\">(</span>\n    <span class=\"token number\">2</span>  <span class=\"token comment\">// step (0-31)</span>\n    <span class=\"token number\">2</span>  <span class=\"token comment\">// instrument (0-2)</span>\n    <span class=\"token number\">89</span> <span class=\"token comment\">// x (0-255)</span>\n    <span class=\"token number\">30</span> <span class=\"token comment\">// y (0-255)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We‚Äôll immediately hit the first bit shift:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">  <span class=\"token keyword\">uint8_t</span> i <span class=\"token operator\">=</span> x <span class=\"token operator\">>></span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 89 >> 6 = b01011001 >> 6 = b00000001 = 1</span>\n\n  <span class=\"token keyword\">uint8_t</span> j <span class=\"token operator\">=</span> y <span class=\"token operator\">>></span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 30 >> 6 = b00011110 >> 6 = b00000000 = 0</span></code></pre></div>\n<p>We can use those numbers to access <code class=\"language-text\">drum_map</code> now:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">  <span class=\"token keyword\">const</span> prog_uint8_t<span class=\"token operator\">*</span> a_map <span class=\"token operator\">=</span> drum_map<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// drum_map[i][j] = drum_map[1][0] = node_15</span>\n\n  <span class=\"token keyword\">const</span> prog_uint8_t<span class=\"token operator\">*</span> b_map <span class=\"token operator\">=</span> drum_map<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// drum_map[i + 1][j] = drum_map[2][0] = node_18</span>\n\n  <span class=\"token keyword\">const</span> prog_uint8_t<span class=\"token operator\">*</span> c_map <span class=\"token operator\">=</span> drum_map<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// drum_map[i][j + 1] = drum_map[1][1] = node_7</span>\n\n  <span class=\"token keyword\">const</span> prog_uint8_t<span class=\"token operator\">*</span> d_map <span class=\"token operator\">=</span> drum_map<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// drum_map[i + 1][j + 1] = drum_map[2][1] = node_14</span></code></pre></div>\n<p>Now we calculate the offset to access the specific probabilites. Note that <code class=\"language-text\">a_map</code> is a pointer to the first byte of the array; the address tells us where to look for the array and incrementing it tells us where in the array to look.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">  <span class=\"token keyword\">uint8_t</span> offset <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>instrument <span class=\"token operator\">*</span> kStepsPerPattern<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> step<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// offset = (2 * 32) + 2 = 64 + 2 = 66</span>\n\n  <span class=\"token keyword\">uint8_t</span> a <span class=\"token operator\">=</span> <span class=\"token function\">pgm_read_byte</span><span class=\"token punctuation\">(</span>a_map <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// node_15[66] = 28</span>\n\n  <span class=\"token keyword\">uint8_t</span> b <span class=\"token operator\">=</span> <span class=\"token function\">pgm_read_byte</span><span class=\"token punctuation\">(</span>b_map <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// node_18[66] = 0</span>\n\n  <span class=\"token keyword\">uint8_t</span> c <span class=\"token operator\">=</span> <span class=\"token function\">pgm_read_byte</span><span class=\"token punctuation\">(</span>c_map <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// node_7[66]  = 72</span>\n\n  <span class=\"token keyword\">uint8_t</span> d <span class=\"token operator\">=</span> <span class=\"token function\">pgm_read_byte</span><span class=\"token punctuation\">(</span>d_map <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// node_14[66] = 8</span></code></pre></div>\n<p>Then blend the four probabilities:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">  <span class=\"token keyword\">return</span> <span class=\"token function\">U8Mix</span><span class=\"token punctuation\">(</span><span class=\"token function\">U8Mix</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> x <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">U8Mix</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> x <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> y <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// U8Mix(a, b, x &lt;&lt; 2) =</span>\n  <span class=\"token comment\">//     U8Mix(28, 0, 89 &lt;&lt; 2) =</span>\n  <span class=\"token comment\">//     U8Mix(28, 0, b01011001 &lt;&lt; 2) =</span>\n  <span class=\"token comment\">//     U8Mix(28, 0, b01100100) =</span>\n  <span class=\"token comment\">//     U8Mix(28, 0, 100)</span>\n  <span class=\"token comment\">// a * (255 - balance) + b * balance >> 8 =</span>\n  <span class=\"token comment\">//     28 * (255 - 100) + 0 * 100 >> 8 =</span>\n  <span class=\"token comment\">//     28 * 155 + 0 >> 8 =</span>\n  <span class=\"token comment\">//     4340 >> 8 =</span>\n  <span class=\"token comment\">//     b0001000011110100 >> 8 =</span>\n  <span class=\"token comment\">//     b00010000 = 16</span>\n\n  <span class=\"token comment\">// U8Mix(a, b, x &lt;&lt; 2) = </span>\n  <span class=\"token comment\">//     U8Mix(72, 8, 89 &lt;&lt; 2) =</span>\n  <span class=\"token comment\">//     U8Mix(72, 8, b01011001 &lt;&lt; 2) = </span>\n  <span class=\"token comment\">//     U8Mix(72, 8, b01100100) =</span>\n  <span class=\"token comment\">//     U8Mix(72, 8, 100)</span>\n  <span class=\"token comment\">// a * (255 - balance) + b * balance >> 8 =</span>\n  <span class=\"token comment\">//     72 * (255 - 100) + 8 * 100 >> 8 =</span>\n  <span class=\"token comment\">//     72 * 155 + 8 >> 8 =</span>\n  <span class=\"token comment\">//     11168 >> 8 =</span>\n  <span class=\"token comment\">//     b0010101110100000 >> 8 = </span>\n  <span class=\"token comment\">//     b00101011 = 43</span>\n\n  <span class=\"token comment\">// U8Mix(a, b, x &lt;&lt; 2) = U8Mix(16, 43, 30 &lt;&lt; 2) =</span>\n  <span class=\"token comment\">//     U8Mix(16, 43, b00011110 &lt;&lt; 2) =</span>\n  <span class=\"token comment\">//     U8Mix(16, 43, b01111000) =</span>\n  <span class=\"token comment\">//     U8Mix(16, 43, 120)</span>\n  <span class=\"token comment\">// a * (255 - balance) + b * balance >> 8 =</span>\n  <span class=\"token comment\">//     16 * (255 - 120) + 43 * 120 >> 8 =</span>\n  <span class=\"token comment\">//     16 * 135 + 5160 >> 8 =</span>\n  <span class=\"token comment\">//     7320 >> 8 =</span>\n  <span class=\"token comment\">//     b0001110010011000 >> 8 =</span>\n  <span class=\"token comment\">//     b00011100 = 28</span></code></pre></div>\n<p>So‚Ä¶</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token function\">ReadDrumMap</span><span class=\"token punctuation\">(</span>\n    <span class=\"token number\">2</span>  <span class=\"token comment\">// step (0-31)</span>\n    <span class=\"token number\">2</span>  <span class=\"token comment\">// instrument (0-2)</span>\n    <span class=\"token number\">89</span> <span class=\"token comment\">// x (0-255)</span>\n    <span class=\"token number\">30</span> <span class=\"token comment\">// y (0-255)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// returns 28</span></code></pre></div>\n<p>Fill is kind of a reverse threshold, so if it‚Äôs turn up enough that the threshold for instrument 2 at step 2 is below 28 then the step will play.</p>\n<h2>Conclusion</h2>\n<p>There‚Äôs a bunch of other bitwise operators in Grids, but these are the ones that stood out to me as I was trying to understand how Grids works. I‚Äôm not sure I‚Äôll be using the same approach as Grids when/if I do something similar with Grandbot, but it was fun learning about this.</p>\n<p>Again, my deepest gratitude to pichenettes and devdsp for sharing their knowledge.</p>\n<p>Happy hacking!</p>","frontmatter":{"title":"MI Grids Bitwise Shift","date":"January 20, 2025","description":"Understanding bitwise shifts as they relate to Mutable Instruments Grids."}}},"pageContext":{"slug":"/grids-bit-shift/","previous":{"fields":{"slug":"/shld-ripchord/"},"frontmatter":{"title":"From MIDI to Ripchord"}},"next":null}},"staticQueryHashes":["63159454"]}